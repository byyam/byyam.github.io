<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"byyam.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Yam&#39;s Notebook">
<meta property="og:url" content="https://byyam.github.io/index.html">
<meta property="og:site_name" content="Yam&#39;s Notebook">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Yam">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://byyam.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Yam's Notebook</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yam's Notebook</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2021/09/17/2021-09-18-pion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/17/2021-09-18-pion/" class="post-title-link" itemprop="url">Pion</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-18 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-18T00:00:00+08:00">2021-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/" itemprop="url" rel="index"><span itemprop="name">media</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Pion是什么"><a href="#Pion是什么" class="headerlink" title="Pion是什么"></a>Pion是什么</h1><p>golang实现的webrtc。</p>
<h2 id="webrtc-peerconnection"><a href="#webrtc-peerconnection" class="headerlink" title="webrtc peerconnection"></a>webrtc peerconnection</h2><p>webrtc里最基本的模块就是peerconnection，代码里经常缩写成pc。</p>
<p>peerconnection对外提供的接口有一部分是On开头的，用于在peerconnection内部发生某事件的回调接口。</p>
<p>使用默认配置新建pc</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pc, err := webrtc.NewPeerConnection(config)</span><br></pre></td></tr></table></figure>

<p>或使用自定义配置新建pc</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peerConnection, err := webrtc.NewAPI(webrtc.WithMediaEngine(m), webrtc.WithInterceptorRegistry(i)).NewPeerConnection(config)</span><br></pre></td></tr></table></figure>

<p>NewAPI接口设计使用<code>Function Option</code>的编程模式，扩展性好。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webrtc可自定义的引擎和调用链，都定义为私有，只能在初始化时从外部指定</span></span><br><span class="line"><span class="keyword">type</span> API <span class="keyword">struct</span> &#123;</span><br><span class="line">	settingEngine       *SettingEngine <span class="comment">// 和ICE，NAT，DTLS等相关的功能，几乎都是标准流程，可定制化的内容很少</span></span><br><span class="line">	mediaEngine         *MediaEngine <span class="comment">// 和pc能力相关的参数，比如codec，extension等</span></span><br><span class="line">	interceptorRegistry *interceptor.Registry <span class="comment">// 和RTP/RTCP包处理相关的功能，比如JitterBuffer，NACK，TWCC等</span></span><br><span class="line"></span><br><span class="line">	interceptor interceptor.Interceptor <span class="comment">// Generated per PeerConnection</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对外初始化接口，可灵活扩展</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPI</span><span class="params">(options ...<span class="keyword">func</span>(*API)</span>) *<span class="title">API</span></span> &#123;</span><br><span class="line">	a := &amp;API&#123;interceptor: &amp;interceptor.NoOp&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> options &#123;</span><br><span class="line">		o(a)</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 外部可自定义实例化这个成员</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithInterceptorRegistry</span><span class="params">(interceptorRegistry *interceptor.Registry)</span> <span class="title">func</span><span class="params">(a *API)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(a *API)</span></span> &#123;</span><br><span class="line">		a.interceptorRegistry = interceptorRegistry</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h3><p>TURN服务器兼容了STUN服务器的功能，即打洞和中继服务器。</p>
<p>STUN消息类型：</p>
<ul>
<li>Request 0x00</li>
<li>Indication 0x01</li>
<li>Success Response 0x02</li>
<li>Error Response 0x03</li>
</ul>
<p>STUN消息方法：</p>
<ul>
<li>Binding 0x001</li>
<li>Allocate 0x003</li>
<li>Refresh 0x004</li>
<li>Send 0x006</li>
<li>Data 0x007</li>
<li>CreatePermission 0x008</li>
<li>ChannelBind 0x009</li>
</ul>
<p><code>turn server</code>实现了一个<code>allocation manager</code>用于管理已授权的client信息，用作管理client的长效鉴权和分配中继信息。</p>
<h4 id="请求分配中继"><a href="#请求分配中继" class="headerlink" title="请求分配中继"></a>请求分配中继</h4><p>TURN client和server之间可选择UDP，TCP（包括TLS）传输STUN消息，TURN server和peer之间一般是UDP传输DATA。</p>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzNzFweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjg5N3B4O2hlaWdodDozNzFweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4OTcgMzcxIiB3aWR0aD0iODk3cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMyLjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI0MjkuNSIgeT0iOTQuNTYyNSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjkuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjQyOS41IiB5PSIxOTIuOTYwOSIvPjxyZWN0IGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7ZmlsbDpub25lOyIgd2lkdGg9IjQxMyIgeD0iNjEiIHk9IjUzLjI5NjkiLz48cmVjdCBoZWlnaHQ9IjgxLjM5ODQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41O2ZpbGw6bm9uZTsiIHdpZHRoPSI4ODIiIHg9IjkiIHk9IjE0OC42OTUzIi8+PHJlY3QgaGVpZ2h0PSI3NS4zOTg0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTtmaWxsOm5vbmU7IiB3aWR0aD0iMjk3IiB4PSIxNzciIHk9IjI0NC4wOTM4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7ZmlsbDpub25lO3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIyMTQiIHgyPSIyMTQiIHkxPSIzNi4yOTY5IiB5Mj0iMzM2LjQ5MjIiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtmaWxsOm5vbmU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjQzNCIgeDI9IjQzNCIgeTE9IjM2LjI5NjkiIHkyPSIzMzYuNDkyMiIvPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTUiIHg9IjE4NyIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxIiB4PSIxOTQiIHk9IjI0Ljk5NTEiPmNsaWVudDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1IiB4PSIxODciIHk9IjMzNS40OTIyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEiIHg9IjE5NCIgeT0iMzU1LjQ4NzMiPmNsaWVudDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU5IiB4PSI0MDUiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NSIgeD0iNDEyIiB5PSIyNC45OTUxIj5zZXJ2ZXI8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1OSIgeD0iNDA1IiB5PSIzMzUuNDkyMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ1IiB4PSI0MTIiIHk9IjM1NS40ODczIj5zZXJ2ZXI8L3RleHQ+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIzMi4xMzI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSIxMCIgeD0iNDI5LjUiIHk9Ijk0LjU2MjUiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI0MjkuNSIgeT0iMTkyLjk2MDkiLz48cGF0aCBkPSJNNjEsNTMuMjk2OSBMMjAxLDUzLjI5NjkgTDIwMSw2MC40Mjk3IEwxOTEsNzAuNDI5NyBMNjEsNzAuNDI5NyBMNjEsNTMuMjk2OSAiIGZpbGw9IiNFRUVFRUUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iNDEzIiB4PSI2MSIgeT0iNTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5NSIgeD0iNzYiIHk9IjY2LjM2MzgiPkFsbG9jYXRlIOWMv+WQjTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQxNy41LDkwLjU2MjUsNDI3LjUsOTQuNTYyNSw0MTcuNSw5OC41NjI1LDQyMS41LDk0LjU2MjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjIxNC41IiB4Mj0iNDIzLjUiIHkxPSI5NC41NjI1IiB5Mj0iOTQuNTYyNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwOCIgeD0iMjIxLjUiIHk9Ijg5LjQ5NjYiPkFsbG9jYXRlIFJlcXVlc3Q8L3RleHQ+PHBhdGggZD0iTTcxLDc1LjQyOTcgTDcxLDEwMC40Mjk3IEwyMDksMTAwLjQyOTcgTDIwOSw4NS40Mjk3IEwxOTksNzUuNDI5NyBMNzEsNzUuNDI5NyAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0xOTksNzUuNDI5NyBMMTk5LDg1LjQyOTcgTDIwOSw4NS40Mjk3IEwxOTksNzUuNDI5NyAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNyIgeD0iNzciIHk9IjkyLjQ5NjYiPuWwneivleS9v+eUqOWMv+WQjeeahOivt+axgjwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIyNS41LDEyMi42OTUzLDIxNS41LDEyNi42OTUzLDIyNS41LDEzMC42OTUzLDIyMS41LDEyNi42OTUzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyMTkuNSIgeDI9IjQzMy41IiB5MT0iMTI2LjY5NTMiIHkyPSIxMjYuNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1MyIgeD0iMjMxLjUiIHk9IjEyMS42Mjk0Ij5BbGxvY2F0ZSBFcnJvciBSZXNwb25zZTwvdGV4dD48cGF0aCBkPSJNOSwxNDguNjk1MyBMMTc3LDE0OC42OTUzIEwxNzcsMTU1LjgyODEgTDE2NywxNjUuODI4MSBMOSwxNjUuODI4MSBMOSwxNDguNjk1MyAiIGZpbGw9IiNFRUVFRUUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iODgyIiB4PSI5IiB5PSIxNDguNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjMiIHg9IjI0IiB5PSIxNjEuNzYyMiI+QWxsb2NhdGUg6ZW/5pWI6Ym05p2DPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDE3LjUsMTg4Ljk2MDksNDI3LjUsMTkyLjk2MDksNDE3LjUsMTk2Ljk2MDksNDIxLjUsMTkyLjk2MDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjIxNC41IiB4Mj0iNDIzLjUiIHkxPSIxOTIuOTYwOSIgeTI9IjE5Mi45NjA5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgyIiB4PSIyMjEuNSIgeT0iMTg3Ljg5NSI+QWxsb2NhdGUgUmVxdWVzdCB3aXRoIG5vbmNlPC90ZXh0PjxwYXRoIGQ9Ik0xOSwxNzAuODI4MSBMMTksMTk1LjgyODEgTDIwOSwxOTUuODI4MSBMMjA5LDE4MC44MjgxIEwxOTksMTcwLjgyODEgTDE5LDE3MC44MjgxICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTE5OSwxNzAuODI4MSBMMTk5LDE4MC44MjgxIEwyMDksMTgwLjgyODEgTDE5OSwxNzAuODI4MSAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2OSIgeD0iMjUiIHk9IjE4Ny44OTUiPuWMv+WQjeivt+axguWksei0pe+8jOS9v+eUqOmJtOadg+aWueW8jzwvdGV4dD48cGF0aCBkPSJNNDQ0LDE3MC44MjgxIEw0NDQsMTk1LjgyODEgTDg4NiwxOTUuODI4MSBMODg2LDE4MC44MjgxIEw4NzYsMTcwLjgyODEgTDQ0NCwxNzAuODI4MSAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik04NzYsMTcwLjgyODEgTDg3NiwxODAuODI4MSBMODg2LDE4MC44MjgxIEw4NzYsMTcwLjgyODEgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MjEiIHg9IjQ1MCIgeT0iMTg3Ljg5NSI+5ZyoWE9SLVJFTEFZRUQtQUREUkVTU+Wtl+autei/lOWbnnNlcnZlcueahHB1YmxpYyBJUO+8jOWcqOmFjee9ruS4reiOt+WPljwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIyNS41LDIxOC4wOTM4LDIxNS41LDIyMi4wOTM4LDIyNS41LDIyNi4wOTM4LDIyMS41LDIyMi4wOTM4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyMTkuNSIgeDI9IjQzMy41IiB5MT0iMjIyLjA5MzgiIHkyPSIyMjIuMDkzOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3NCIgeD0iMjMxLjUiIHk9IjIxNy4wMjc4Ij5BbGxvY2F0ZSBTdWNjZXNzIFJlc3BvbnNlPC90ZXh0PjxwYXRoIGQ9Ik0xNzcsMjQ0LjA5MzggTDI2NCwyNDQuMDkzOCBMMjY0LDI1MS4yMjY2IEwyNTQsMjYxLjIyNjYgTDE3NywyNjEuMjI2NiBMMTc3LDI0NC4wOTM4ICIgZmlsbD0iI0VFRUVFRSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7Ii8+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI3NS4zOTg0IiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTsiIHdpZHRoPSIyOTciIHg9IjE3NyIgeT0iMjQ0LjA5MzgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDIiIHg9IjE5MiIgeT0iMjU3LjE2MDYiPuS4jeWPr+i+vjwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQyMi41LDI3OC4zNTk0LDQzMi41LDI4Mi4zNTk0LDQyMi41LDI4Ni4zNTk0LDQyNi41LDI4Mi4zNTk0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyMTQuNSIgeDI9IjQyOC41IiB5MT0iMjgyLjM1OTQiIHkyPSIyODIuMzU5NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1MSIgeD0iMjIxLjUiIHk9IjI3Ny4yOTM1Ij5TVFVOOiBBbGxvY2F0ZSBSZXF1ZXN0PC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjI1LjUsMzA3LjQ5MjIsMjE1LjUsMzExLjQ5MjIsMjI1LjUsMzE1LjQ5MjIsMjIxLjUsMzExLjQ5MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjIxOS41IiB4Mj0iNDMzLjUiIHkxPSIzMTEuNDkyMiIgeTI9IjMxMS40OTIyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTk2IiB4PSIyMzEuNSIgeT0iMzA2LjQyNjMiPklDTVA6IERlc3RpbmF0aW9uIFVucmVhY2hhYmxlPC90ZXh0PjwhLS1NRDU9WzM2NmViMjA4MTEyOWE0NDEwZDkzZDM5ZTY1NTY4OWU5XQpAc3RhcnR1bWwNCnNraW5wYXJhbSBOb3RlQmFja2dyb3VuZENvbG9yIHdoaXRlDQoNCmdyb3VwIEFsbG9jYXRlIOWMv+WQjQ0KY2xpZW50IC0+IHNlcnZlciA6IEFsbG9jYXRlIFJlcXVlc3QNCmFjdGl2YXRlIHNlcnZlcg0Kbm90ZSBsZWZ0OiDlsJ3or5Xkvb/nlKjljL/lkI3nmoTor7fmsYINCnNlcnZlciAtPiBjbGllbnQgOiBBbGxvY2F0ZSBFcnJvciBSZXNwb25zZQ0KZGVhY3RpdmF0ZSBzZXJ2ZXINCmVuZA0KDQoNCmdyb3VwIEFsbG9jYXRlIOmVv+aViOmJtOadgw0KY2xpZW50IC0+IHNlcnZlciA6IEFsbG9jYXRlIFJlcXVlc3Qgd2l0aCBub25jZQ0KYWN0aXZhdGUgc2VydmVyDQpub3RlIGxlZnQ6IOWMv+WQjeivt+axguWksei0pe+8jOS9v+eUqOmJtOadg+aWueW8jw0Kbm90ZSByaWdodDog5ZyoWE9SLVJFTEFZRUQtQUREUkVTU+Wtl+autei/lOWbnnNlcnZlcueahHB1YmxpYyBJUO+8jOWcqOmFjee9ruS4reiOt+WPlg0Kc2VydmVyIC0+IGNsaWVudCA6IEFsbG9jYXRlIFN1Y2Nlc3MgUmVzcG9uc2UNCmRlYWN0aXZhdGUgc2VydmVyDQplbmQNCg0KZ3JvdXAg5LiN5Y+v6L6+DQpjbGllbnQgLT4gc2VydmVyIDogU1RVTjogQWxsb2NhdGUgUmVxdWVzdA0Kc2VydmVyIC0+IGNsaWVudCA6IElDTVA6IERlc3RpbmF0aW9uIFVucmVhY2hhYmxlDQplbmQNCkBlbmR1bWwNCgpQbGFudFVNTCB2ZXJzaW9uIDEuMjAyMi4zYmV0YTIoVW5rbm93biBjb21waWxlIHRpbWUpCihHUEwgc291cmNlIGRpc3RyaWJ1dGlvbikKSmF2YSBSdW50aW1lOiBKYXZhKFRNKSBTRSBSdW50aW1lIEVudmlyb25tZW50CkpWTTogSmF2YSBIb3RTcG90KFRNKSA2NC1CaXQgU2VydmVyIFZNCkRlZmF1bHQgRW5jb2Rpbmc6IFVURi04Ckxhbmd1YWdlOiBlbgpDb3VudHJ5OiBVUwotLT48L2c+PC9zdmc+'>

<h4 id="数据交换之转发机制"><a href="#数据交换之转发机制" class="headerlink" title="数据交换之转发机制"></a>数据交换之转发机制</h4><p>使用Indication标识转发数据，Send和Data不支持长效验证，因此需要先获得permission再开始indication发送数据。一旦permission建立，信任这个address发来的数据，时效5min，且无法通过收发数据刷新时效。</p>
<p>webrtc使用indication做连通性测试，即Ping。</p>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzNDZweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjExMzBweDtoZWlnaHQ6MzQ2cHg7YmFja2dyb3VuZDojRkZGRkZGOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgMTEzMCAzNDYiIHdpZHRoPSIxMTMwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMyLjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NTcuNSIgeT0iOTQuNTYyNSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjkuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY1Ny41IiB5PSIxOTIuOTYwOSIvPjxyZWN0IGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7ZmlsbDpub25lOyIgd2lkdGg9Ijc2NC41IiB4PSIzNjAiIHk9IjUzLjI5NjkiLz48cmVjdCBoZWlnaHQ9IjE0NS42NjQxIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTtmaWxsOm5vbmU7IiB3aWR0aD0iODYwLjUiIHg9IjkiIHk9IjE0OC42OTUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7ZmlsbDpub25lO3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIzOTciIHgyPSIzOTciIHkxPSIzNi4yOTY5IiB5Mj0iMzExLjM1OTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtmaWxsOm5vbmU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjY2MiIgeDI9IjY2MiIgeTE9IjM2LjI5NjkiIHkyPSIzMTEuMzU5NCIvPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTUiIHg9IjM3MCIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxIiB4PSIzNzciIHk9IjI0Ljk5NTEiPmNsaWVudDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1IiB4PSIzNzAiIHk9IjMxMC4zNTk0Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEiIHg9IjM3NyIgeT0iMzMwLjM1NDUiPmNsaWVudDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU5IiB4PSI2MzMiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NSIgeD0iNjQwIiB5PSIyNC45OTUxIj5zZXJ2ZXI8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1OSIgeD0iNjMzIiB5PSIzMTAuMzU5NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ1IiB4PSI2NDAiIHk9IjMzMC4zNTQ1Ij5zZXJ2ZXI8L3RleHQ+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIzMi4xMzI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSIxMCIgeD0iNjU3LjUiIHk9Ijk0LjU2MjUiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NTcuNSIgeT0iMTkyLjk2MDkiLz48cGF0aCBkPSJNMzYwLDUzLjI5NjkgTDQzNyw1My4yOTY5IEw0MzcsNjAuNDI5NyBMNDI3LDcwLjQyOTcgTDM2MCw3MC40Mjk3IEwzNjAsNTMuMjk2OSAiIGZpbGw9IiNFRUVFRUUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iNzY0LjUiIHg9IjM2MCIgeT0iNTMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzMiIgeD0iMzc1IiB5PSI2Ni4zNjM4Ij5QaW5nPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjQ1LjUsOTAuNTYyNSw2NTUuNSw5NC41NjI1LDY0NS41LDk4LjU2MjUsNjQ5LjUsOTQuNTYyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMzk3LjUiIHgyPSI2NTEuNSIgeTE9Ijk0LjU2MjUiIHkyPSI5NC41NjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTAzIiB4PSI0MDQuNSIgeT0iODkuNDk2NiI+QmluZGluZyBSZXF1ZXN0PC90ZXh0PjxwYXRoIGQ9Ik02NzIsNzUuNDI5NyBMNjcyLDEwMC40Mjk3IEwxMTE5LDEwMC40Mjk3IEwxMTE5LDg1LjQyOTcgTDExMDksNzUuNDI5NyBMNjcyLDc1LjQyOTcgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMTEwOSw3NS40Mjk3IEwxMTA5LDg1LjQyOTcgTDExMTksODUuNDI5NyBMMTEwOSw3NS40Mjk3ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDI2IiB4PSI2NzgiIHk9IjkyLjQ5NjYiPuWcqFhPUi1NQVBQRUQtQUREUkVTU+Wtl+autei/lOWbnmNsaWVudOeahGV4dGVybmFsIElQ77yMc2VydmVy55yL5Yiw55qEPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDA4LjUsMTIyLjY5NTMsMzk4LjUsMTI2LjY5NTMsNDA4LjUsMTMwLjY5NTMsNDA0LjUsMTI2LjY5NTMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQwMi41IiB4Mj0iNjYxLjUiIHkxPSIxMjYuNjk1MyIgeTI9IjEyNi42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTY5IiB4PSI0MTQuNSIgeT0iMTIxLjYyOTQiPkJpbmRpbmcgU3VjY2VzcyBSZXNwb25zZTwvdGV4dD48cGF0aCBkPSJNOSwxNDguNjk1MyBMMTEwLDE0OC42OTUzIEwxMTAsMTU1LjgyODEgTDEwMCwxNjUuODI4MSBMOSwxNjUuODI4MSBMOSwxNDguNjk1MyAiIGZpbGw9IiNFRUVFRUUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iMTQ1LjY2NDEiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9Ijg2MC41IiB4PSI5IiB5PSIxNDguNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NiIgeD0iMjQiIHk9IjE2MS43NjIyIj7ovazlj5HmlbDmja48L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NDUuNSwxODguOTYwOSw2NTUuNSwxOTIuOTYwOSw2NDUuNSwxOTYuOTYwOSw2NDkuNSwxOTIuOTYwOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMzk3LjUiIHgyPSI2NTEuNSIgeTE9IjE5Mi45NjA5IiB5Mj0iMTkyLjk2MDkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzAiIHg9IjQwNC41IiB5PSIxODcuODk1Ij5DcmVhdGVQZXJtaXNzaW9uIFJlcXVlc3Q8L3RleHQ+PHBhdGggZD0iTTE5LDE3MC44MjgxIEwxOSwxOTUuODI4MSBMMzkyLDE5NS44MjgxIEwzOTIsMTgwLjgyODEgTDM4MiwxNzAuODI4MSBMMTksMTcwLjgyODEgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMzgyLDE3MC44MjgxIEwzODIsMTgwLjgyODEgTDM5MiwxODAuODI4MSBMMzgyLDE3MC44MjgxICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzUyIiB4PSIyNSIgeT0iMTg3Ljg5NSI+5bim5LiK6Ym05p2D5L+h5oGv77yMWE9SLVBFRVItQUREUkVTU+Whq2NsaWVudOeahGV4dGVybmFsIElQPC90ZXh0PjxwYXRoIGQ9Ik02NzIsMTcwLjgyODEgTDY3MiwxOTUuODI4MSBMODQxLDE5NS44MjgxIEw4NDEsMTgwLjgyODEgTDgzMSwxNzAuODI4MSBMNjcyLDE3MC44MjgxICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTgzMSwxNzAuODI4MSBMODMxLDE4MC44MjgxIEw4NDEsMTgwLjgyODEgTDgzMSwxNzAuODI4MSAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0OCIgeD0iNjc4IiB5PSIxODcuODk1Ij7orrDlvZXlnKhwZXJtaXNzaW9u5YiX6KGo5LitPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDA4LjUsMjE4LjA5MzgsMzk4LjUsMjIyLjA5MzgsNDA4LjUsMjI2LjA5MzgsNDA0LjUsMjIyLjA5MzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQwMi41IiB4Mj0iNjYxLjUiIHkxPSIyMjIuMDkzOCIgeTI9IjIyMi4wOTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjM2IiB4PSI0MTQuNSIgeT0iMjE3LjAyNzgiPkNyZWF0ZVBlcm1pc3Npb24gU3VjY2VzcyBSZXNwb25zZTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY1MC41LDI1MC4yMjY2LDY2MC41LDI1NC4yMjY2LDY1MC41LDI1OC4yMjY2LDY1NC41LDI1NC4yMjY2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIzOTcuNSIgeDI9IjY1Ni41IiB5MT0iMjU0LjIyNjYiIHkyPSIyNTQuMjI2NiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3IiB4PSI0MDQuNSIgeT0iMjQ5LjE2MDYiPlNlbmQgSW5kaWNhdGlvbjwvdGV4dD48cGF0aCBkPSJNNjY3LDIzNS4wOTM4IEw2NjcsMjYwLjA5MzggTDg1NCwyNjAuMDkzOCBMODU0LDI0NS4wOTM4IEw4NDQsMjM1LjA5MzggTDY2NywyMzUuMDkzOCAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik04NDQsMjM1LjA5MzggTDg0NCwyNDUuMDkzOCBMODU0LDI0NS4wOTM4IEw4NDQsMjM1LjA5MzggIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjYiIHg9IjY3MyIgeT0iMjUyLjE2MDYiPuS7jkRBVEHlrZfmrrXop6PmnpDlubbovazlj5HmlbDmja48L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MDguNSwyODIuMzU5NCwzOTguNSwyODYuMzU5NCw0MDguNSwyOTAuMzU5NCw0MDQuNSwyODYuMzU5NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDAyLjUiIHgyPSI2NjEuNSIgeTE9IjI4Ni4zNTk0IiB5Mj0iMjg2LjM1OTQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5NiIgeD0iNDE0LjUiIHk9IjI4MS4yOTM1Ij5EYXRhIEluZGljYXRpb248L3RleHQ+PCEtLU1ENT1bZjY1YjRhZDU2MjM2N2Y0ZjRmOWZlMGI4M2NmODMwMDhdCkBzdGFydHVtbA0Kc2tpbnBhcmFtIE5vdGVCYWNrZ3JvdW5kQ29sb3Igd2hpdGUNCg0KZ3JvdXAgUGluZw0KY2xpZW50IC0+IHNlcnZlciA6IEJpbmRpbmcgUmVxdWVzdA0KYWN0aXZhdGUgc2VydmVyDQpub3RlIHJpZ2h0OiDlnKhYT1ItTUFQUEVELUFERFJFU1PlrZfmrrXov5Tlm55jbGllbnTnmoRleHRlcm5hbCBJUO+8jHNlcnZlcueci+WIsOeahA0Kc2VydmVyIC0+IGNsaWVudCA6IEJpbmRpbmcgU3VjY2VzcyBSZXNwb25zZQ0KZGVhY3RpdmF0ZSBzZXJ2ZXINCmVuZA0KDQpncm91cCDovazlj5HmlbDmja4NCmNsaWVudCAtPiBzZXJ2ZXIgOiBDcmVhdGVQZXJtaXNzaW9uIFJlcXVlc3QNCmFjdGl2YXRlIHNlcnZlcg0Kbm90ZSBsZWZ0OiDluKbkuIrpibTmnYPkv6Hmga/vvIxYT1ItUEVFUi1BRERSRVNT5aGrY2xpZW5055qEZXh0ZXJuYWwgSVANCm5vdGUgcmlnaHQ6IOiusOW9leWcqHBlcm1pc3Npb27liJfooajkuK0NCnNlcnZlciAtPiBjbGllbnQgOiBDcmVhdGVQZXJtaXNzaW9uIFN1Y2Nlc3MgUmVzcG9uc2UNCmRlYWN0aXZhdGUgc2VydmVyDQoNCmNsaWVudCAtPiBzZXJ2ZXIgOiBTZW5kIEluZGljYXRpb24NCm5vdGUgcmlnaHQ6IOS7jkRBVEHlrZfmrrXop6PmnpDlubbovazlj5HmlbDmja4NCnNlcnZlciAtPiBjbGllbnQgOiBEYXRhIEluZGljYXRpb24NCg0KZW5kDQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjIuM2JldGEyKFVua25vd24gY29tcGlsZSB0aW1lKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogSmF2YShUTSkgU0UgUnVudGltZSBFbnZpcm9ubWVudApKVk06IEphdmEgSG90U3BvdChUTSkgNjQtQml0IFNlcnZlciBWTQpEZWZhdWx0IEVuY29kaW5nOiBVVEYtOApMYW5ndWFnZTogZW4KQ291bnRyeTogVVMKLS0+PC9nPjwvc3ZnPg=='>

<h4 id="数据交换之信道机制"><a href="#数据交换之信道机制" class="headerlink" title="数据交换之信道机制"></a>数据交换之信道机制</h4><p><code>send/data indication</code>添加在stun的应用层的头部，需要36字节的开销，在有些带宽资源敏感的场景，比如VoIP，就显著增加了带宽。turn提供了ChannelData消息格式做数据交换。</p>
<p>ChannelData不使用stun应用头部，而是使用4字节的信道号做标识。client在request消息带上未绑定的信道编号和地址信息给server，server若同意绑定，client就可以使用这个信道编号发送ChannelData消息给目的peer，server也可以通过这个信道转发数据给client。</p>
<p>channel时效10min，ChannelData消息或重新绑定channel到peer都可以刷新channel的时效，但是它只能过期，不能像indication通过设置lifetime=0立即失效。</p>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzNDZweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjExMzBweDtoZWlnaHQ6MzQ2cHg7YmFja2dyb3VuZDojRkZGRkZGOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgMTEzMCAzNDYiIHdpZHRoPSIxMTMwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NTcuNSIgeT0iOTcuNTYyNSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjkuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY1Ny41IiB5PSIxOTIuOTYwOSIvPjxyZWN0IGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7ZmlsbDpub25lOyIgd2lkdGg9IjEwNzIiIHg9IjUyIiB5PSI1My4yOTY5Ii8+PHJlY3QgaGVpZ2h0PSIxNDUuNjY0MSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7ZmlsbDpub25lOyIgd2lkdGg9Ijg2MC41IiB4PSI5IiB5PSIxNDguNjk1MyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O2ZpbGw6bm9uZTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iMzk3IiB4Mj0iMzk3IiB5MT0iMzYuMjk2OSIgeTI9IjMxMS4zNTk0Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7ZmlsbDpub25lO3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSI2NjIiIHgyPSI2NjIiIHkxPSIzNi4yOTY5IiB5Mj0iMzExLjM1OTQiLz48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1IiB4PSIzNzAiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MSIgeD0iMzc3IiB5PSIyNC45OTUxIj5jbGllbnQ8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1NSIgeD0iMzcwIiB5PSIzMTAuMzU5NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxIiB4PSIzNzciIHk9IjMzMC4zNTQ1Ij5jbGllbnQ8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1OSIgeD0iNjMzIiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDUiIHg9IjY0MCIgeT0iMjQuOTk1MSI+c2VydmVyPC90ZXh0PjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTkiIHg9IjYzMyIgeT0iMzEwLjM1OTQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NSIgeD0iNjQwIiB5PSIzMzAuMzU0NSI+c2VydmVyPC90ZXh0PjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjkuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY1Ny41IiB5PSI5Ny41NjI1Ii8+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyOS4xMzI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSIxMCIgeD0iNjU3LjUiIHk9IjE5Mi45NjA5Ii8+PHBhdGggZD0iTTUyLDUzLjI5NjkgTDE4Miw1My4yOTY5IEwxODIsNjAuNDI5NyBMMTcyLDcwLjQyOTcgTDUyLDcwLjQyOTcgTDUyLDUzLjI5NjkgIiBmaWxsPSIjRUVFRUVFIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTsiLz48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjgxLjM5ODQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjEwNzIiIHg9IjUyIiB5PSI1My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijg1IiB4PSI2NyIgeT0iNjYuMzYzOCI+5YiG6YWNY2hhbm5lbDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY0NS41LDkzLjU2MjUsNjU1LjUsOTcuNTYyNSw2NDUuNSwxMDEuNTYyNSw2NDkuNSw5Ny41NjI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIzOTcuNSIgeDI9IjY1MS41IiB5MT0iOTcuNTYyNSIgeTI9Ijk3LjU2MjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDEiIHg9IjQwNC41IiB5PSI5Mi40OTY2Ij5DaGFubmVsLUJpbmQgUmVxdWVzdDwvdGV4dD48cGF0aCBkPSJNNjIsNzUuNDI5NyBMNjIsMTAwLjQyOTcgTDM5MiwxMDAuNDI5NyBMMzkyLDg1LjQyOTcgTDM4Miw3NS40Mjk3IEw2Miw3NS40Mjk3ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTM4Miw3NS40Mjk3IEwzODIsODUuNDI5NyBMMzkyLDg1LjQyOTcgTDM4Miw3NS40Mjk3ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzA5IiB4PSI2OCIgeT0iOTIuNDk2NiI+5bim5LiK5YiG6YWN5aW955qEY2hhbm5lbCBudW1iZXLlkox0cmFuc3BvcnQgYWRkcmVzczwvdGV4dD48cGF0aCBkPSJNNjcyLDc1LjQyOTcgTDY3MiwxMDAuNDI5NyBMMTExOSwxMDAuNDI5NyBMMTExOSw4NS40Mjk3IEwxMTA5LDc1LjQyOTcgTDY3Miw3NS40Mjk3ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTExMDksNzUuNDI5NyBMMTEwOSw4NS40Mjk3IEwxMTE5LDg1LjQyOTcgTDExMDksNzUuNDI5NyAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQyNiIgeD0iNjc4IiB5PSI5Mi40OTY2Ij7lnKhYT1ItTUFQUEVELUFERFJFU1PlrZfmrrXov5Tlm55jbGllbnTnmoRleHRlcm5hbCBJUO+8jHNlcnZlcueci+WIsOeahDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQwOC41LDEyMi42OTUzLDM5OC41LDEyNi42OTUzLDQwOC41LDEzMC42OTUzLDQwNC41LDEyNi42OTUzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0MDIuNSIgeDI9IjY2MS41IiB5MT0iMTI2LjY5NTMiIHkyPSIxMjYuNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIwNyIgeD0iNDE0LjUiIHk9IjEyMS42Mjk0Ij5DaGFubmVsLUJpbmQgU3VjY2VzcyBSZXNwb25zZTwvdGV4dD48cGF0aCBkPSJNOSwxNDguNjk1MyBMMTEwLDE0OC42OTUzIEwxMTAsMTU1LjgyODEgTDEwMCwxNjUuODI4MSBMOSwxNjUuODI4MSBMOSwxNDguNjk1MyAiIGZpbGw9IiNFRUVFRUUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iMTQ1LjY2NDEiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9Ijg2MC41IiB4PSI5IiB5PSIxNDguNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NiIgeD0iMjQiIHk9IjE2MS43NjIyIj7ovazlj5HmlbDmja48L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NDUuNSwxODguOTYwOSw2NTUuNSwxOTIuOTYwOSw2NDUuNSwxOTYuOTYwOSw2NDkuNSwxOTIuOTYwOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMzk3LjUiIHgyPSI2NTEuNSIgeTE9IjE5Mi45NjA5IiB5Mj0iMTkyLjk2MDkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzAiIHg9IjQwNC41IiB5PSIxODcuODk1Ij5DcmVhdGVQZXJtaXNzaW9uIFJlcXVlc3Q8L3RleHQ+PHBhdGggZD0iTTE5LDE3MC44MjgxIEwxOSwxOTUuODI4MSBMMzkyLDE5NS44MjgxIEwzOTIsMTgwLjgyODEgTDM4MiwxNzAuODI4MSBMMTksMTcwLjgyODEgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMzgyLDE3MC44MjgxIEwzODIsMTgwLjgyODEgTDM5MiwxODAuODI4MSBMMzgyLDE3MC44MjgxICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzUyIiB4PSIyNSIgeT0iMTg3Ljg5NSI+5bim5LiK6Ym05p2D5L+h5oGv77yMWE9SLVBFRVItQUREUkVTU+Whq2NsaWVudOeahGV4dGVybmFsIElQPC90ZXh0PjxwYXRoIGQ9Ik02NzIsMTcwLjgyODEgTDY3MiwxOTUuODI4MSBMODQxLDE5NS44MjgxIEw4NDEsMTgwLjgyODEgTDgzMSwxNzAuODI4MSBMNjcyLDE3MC44MjgxICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTgzMSwxNzAuODI4MSBMODMxLDE4MC44MjgxIEw4NDEsMTgwLjgyODEgTDgzMSwxNzAuODI4MSAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0OCIgeD0iNjc4IiB5PSIxODcuODk1Ij7orrDlvZXlnKhwZXJtaXNzaW9u5YiX6KGo5LitPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDA4LjUsMjE4LjA5MzgsMzk4LjUsMjIyLjA5MzgsNDA4LjUsMjI2LjA5MzgsNDA0LjUsMjIyLjA5MzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQwMi41IiB4Mj0iNjYxLjUiIHkxPSIyMjIuMDkzOCIgeTI9IjIyMi4wOTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjM2IiB4PSI0MTQuNSIgeT0iMjE3LjAyNzgiPkNyZWF0ZVBlcm1pc3Npb24gU3VjY2VzcyBSZXNwb25zZTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY1MC41LDI1MC4yMjY2LDY2MC41LDI1NC4yMjY2LDY1MC41LDI1OC4yMjY2LDY1NC41LDI1NC4yMjY2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIzOTcuNSIgeDI9IjY1Ni41IiB5MT0iMjU0LjIyNjYiIHkyPSIyNTQuMjI2NiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3IiB4PSI0MDQuNSIgeT0iMjQ5LjE2MDYiPlNlbmQgSW5kaWNhdGlvbjwvdGV4dD48cGF0aCBkPSJNNjY3LDIzNS4wOTM4IEw2NjcsMjYwLjA5MzggTDg1NCwyNjAuMDkzOCBMODU0LDI0NS4wOTM4IEw4NDQsMjM1LjA5MzggTDY2NywyMzUuMDkzOCAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik04NDQsMjM1LjA5MzggTDg0NCwyNDUuMDkzOCBMODU0LDI0NS4wOTM4IEw4NDQsMjM1LjA5MzggIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjYiIHg9IjY3MyIgeT0iMjUyLjE2MDYiPuS7jkRBVEHlrZfmrrXop6PmnpDlubbovazlj5HmlbDmja48L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MDguNSwyODIuMzU5NCwzOTguNSwyODYuMzU5NCw0MDguNSwyOTAuMzU5NCw0MDQuNSwyODYuMzU5NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDAyLjUiIHgyPSI2NjEuNSIgeTE9IjI4Ni4zNTk0IiB5Mj0iMjg2LjM1OTQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5NiIgeD0iNDE0LjUiIHk9IjI4MS4yOTM1Ij5EYXRhIEluZGljYXRpb248L3RleHQ+PCEtLU1ENT1bZTFiMmQ3NzA1M2QwOTJkOTgyN2Y5ZTIxNGM3NWNlYWFdCkBzdGFydHVtbA0Kc2tpbnBhcmFtIE5vdGVCYWNrZ3JvdW5kQ29sb3Igd2hpdGUNCg0KZ3JvdXAg5YiG6YWNY2hhbm5lbA0KY2xpZW50IC0+IHNlcnZlciA6IENoYW5uZWwtQmluZCBSZXF1ZXN0DQphY3RpdmF0ZSBzZXJ2ZXINCm5vdGUgbGVmdDog5bim5LiK5YiG6YWN5aW955qEY2hhbm5lbCBudW1iZXLlkox0cmFuc3BvcnQgYWRkcmVzcw0Kbm90ZSByaWdodDog5ZyoWE9SLU1BUFBFRC1BRERSRVNT5a2X5q616L+U5ZueY2xpZW5055qEZXh0ZXJuYWwgSVDvvIxzZXJ2ZXLnnIvliLDnmoQNCnNlcnZlciAtPiBjbGllbnQgOiBDaGFubmVsLUJpbmQgU3VjY2VzcyBSZXNwb25zZQ0KZGVhY3RpdmF0ZSBzZXJ2ZXINCmVuZA0KDQpncm91cCDovazlj5HmlbDmja4NCmNsaWVudCAtPiBzZXJ2ZXIgOiBDcmVhdGVQZXJtaXNzaW9uIFJlcXVlc3QNCmFjdGl2YXRlIHNlcnZlcg0Kbm90ZSBsZWZ0OiDluKbkuIrpibTmnYPkv6Hmga/vvIxYT1ItUEVFUi1BRERSRVNT5aGrY2xpZW5055qEZXh0ZXJuYWwgSVANCm5vdGUgcmlnaHQ6IOiusOW9leWcqHBlcm1pc3Npb27liJfooajkuK0NCnNlcnZlciAtPiBjbGllbnQgOiBDcmVhdGVQZXJtaXNzaW9uIFN1Y2Nlc3MgUmVzcG9uc2UNCmRlYWN0aXZhdGUgc2VydmVyDQoNCmNsaWVudCAtPiBzZXJ2ZXIgOiBTZW5kIEluZGljYXRpb24NCm5vdGUgcmlnaHQ6IOS7jkRBVEHlrZfmrrXop6PmnpDlubbovazlj5HmlbDmja4NCnNlcnZlciAtPiBjbGllbnQgOiBEYXRhIEluZGljYXRpb24NCg0KZW5kDQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjIuM2JldGEyKFVua25vd24gY29tcGlsZSB0aW1lKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogSmF2YShUTSkgU0UgUnVudGltZSBFbnZpcm9ubWVudApKVk06IEphdmEgSG90U3BvdChUTSkgNjQtQml0IFNlcnZlciBWTQpEZWZhdWx0IEVuY29kaW5nOiBVVEYtOApMYW5ndWFnZTogZW4KQ291bnRyeTogVVMKLS0+PC9nPjwvc3ZnPg=='>



<h4 id="保活机制"><a href="#保活机制" class="headerlink" title="保活机制"></a>保活机制</h4><p>中继分配好之后，中继信息存在server的allocation map里，客户端需要发送refresh消息进行保活，refresh消息也必须带上鉴权信息。<br>server每次收到新的refresh请求，更新lifetime，给allocation续期。</p>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjY0NHB4O2hlaWdodDoyODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA2NDQgMjgyIiB3aWR0aD0iNjQ0cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSIzNzguNSIgeT0iOTcuNTYyNSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjkuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjM3OC41IiB5PSIxOTIuOTYwOSIvPjxyZWN0IGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7ZmlsbDpub25lOyIgd2lkdGg9IjU2MCIgeD0iOSIgeT0iNTMuMjk2OSIvPjxyZWN0IGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7ZmlsbDpub25lOyIgd2lkdGg9IjU1OSIgeD0iNzkiIHk9IjE0OC42OTUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7ZmlsbDpub25lO3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIxODEiIHgyPSIxODEiIHkxPSIzNi4yOTY5IiB5Mj0iMjQ3LjA5MzgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtmaWxsOm5vbmU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjM4MyIgeDI9IjM4MyIgeTE9IjM2LjI5NjkiIHkyPSIyNDcuMDkzOCIvPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTUiIHg9IjE1NCIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxIiB4PSIxNjEiIHk9IjI0Ljk5NTEiPmNsaWVudDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1IiB4PSIxNTQiIHk9IjI0Ni4wOTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEiIHg9IjE2MSIgeT0iMjY2LjA4ODkiPmNsaWVudDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU5IiB4PSIzNTQiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NSIgeD0iMzYxIiB5PSIyNC45OTUxIj5zZXJ2ZXI8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1OSIgeD0iMzU0IiB5PSIyNDYuMDkzOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ1IiB4PSIzNjEiIHk9IjI2Ni4wODg5Ij5zZXJ2ZXI8L3RleHQ+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyOS4xMzI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSIxMCIgeD0iMzc4LjUiIHk9Ijk3LjU2MjUiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSIzNzguNSIgeT0iMTkyLjk2MDkiLz48cGF0aCBkPSJNOSw1My4yOTY5IEwxNTcsNTMuMjk2OSBMMTU3LDYwLjQyOTcgTDE0Nyw3MC40Mjk3IEw5LDcwLjQyOTcgTDksNTMuMjk2OSAiIGZpbGw9IiNFRUVFRUUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iODEuMzk4NCIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iNTYwIiB4PSI5IiB5PSI1My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMyIgeD0iMjQiIHk9IjY2LjM2MzgiPue7reacn2FsbG9jYXRpb248L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjYuNSw5My41NjI1LDM3Ni41LDk3LjU2MjUsMzY2LjUsMTAxLjU2MjUsMzcwLjUsOTcuNTYyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMTgxLjUiIHgyPSIzNzIuNSIgeTE9Ijk3LjU2MjUiIHkyPSI5Ny41NjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA3IiB4PSIxODguNSIgeT0iOTIuNDk2NiI+UmVmcmVzaCBSZXF1ZXN0PC90ZXh0PjxwYXRoIGQ9Ik0xOSw3NS40Mjk3IEwxOSwxMDAuNDI5NyBMMTc2LDEwMC40Mjk3IEwxNzYsODUuNDI5NyBMMTY2LDc1LjQyOTcgTDE5LDc1LjQyOTcgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMTY2LDc1LjQyOTcgTDE2Niw4NS40Mjk3IEwxNzYsODUuNDI5NyBMMTY2LDc1LjQyOTcgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzYiIHg9IjI1IiB5PSI5Mi40OTY2Ij5saWZldGltZSZndDsw77yM6buY6K6kNjAwczwvdGV4dD48cGF0aCBkPSJNMzkzLDc1LjQyOTcgTDM5MywxMDAuNDI5NyBMNTY0LDEwMC40Mjk3IEw1NjQsODUuNDI5NyBMNTU0LDc1LjQyOTcgTDM5Myw3NS40Mjk3ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTU1NCw3NS40Mjk3IEw1NTQsODUuNDI5NyBMNTY0LDg1LjQyOTcgTDU1NCw3NS40Mjk3ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUwIiB4PSIzOTkiIHk9IjkyLjQ5NjYiPnNldCBsaWZldGltZe+8jOWIt+aWsOWumuaXtuWZqDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE5Mi41LDEyMi42OTUzLDE4Mi41LDEyNi42OTUzLDE5Mi41LDEzMC42OTUzLDE4OC41LDEyNi42OTUzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxODYuNSIgeDI9IjM4Mi41IiB5MT0iMTI2LjY5NTMiIHkyPSIxMjYuNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3MyIgeD0iMTk4LjUiIHk9IjEyMS42Mjk0Ij5SZWZyZXNoIFN1Y2Nlc3MgUmVzcG9uc2U8L3RleHQ+PHBhdGggZD0iTTc5LDE0OC42OTUzIEwyNjksMTQ4LjY5NTMgTDI2OSwxNTUuODI4MSBMMjU5LDE2NS44MjgxIEw3OSwxNjUuODI4MSBMNzksMTQ4LjY5NTMgIiBmaWxsPSIjRUVFRUVFIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTsiLz48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjgxLjM5ODQiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjU1OSIgeD0iNzkiIHk9IjE0OC42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0NSIgeD0iOTQiIHk9IjE2MS43NjIyIj5EaXNjb25uZWN0IOaWreW8gOi/nuaOpTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM2Ni41LDE4OC45NjA5LDM3Ni41LDE5Mi45NjA5LDM2Ni41LDE5Ni45NjA5LDM3MC41LDE5Mi45NjA5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxODEuNSIgeDI9IjM3Mi41IiB5MT0iMTkyLjk2MDkiIHkyPSIxOTIuOTYwOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNyIgeD0iMTg4LjUiIHk9IjE4Ny44OTUiPlJlZnJlc2ggUmVxdWVzdDwvdGV4dD48cGF0aCBkPSJNODksMTcwLjgyODEgTDg5LDE5NS44MjgxIEwxNzYsMTk1LjgyODEgTDE3NiwxODAuODI4MSBMMTY2LDE3MC44MjgxIEw4OSwxNzAuODI4MSAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0xNjYsMTcwLjgyODEgTDE2NiwxODAuODI4MSBMMTc2LDE4MC44MjgxIEwxNjYsMTcwLjgyODEgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NiIgeD0iOTUiIHk9IjE4Ny44OTUiPmxpZmV0aW1lPTA8L3RleHQ+PHBhdGggZD0iTTM5MywxNzAuODI4MSBMMzkzLDE5NS44MjgxIEw2MzMsMTk1LjgyODEgTDYzMywxODAuODI4MSBMNjIzLDE3MC44MjgxIEwzOTMsMTcwLjgyODEgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNjIzLDE3MC44MjgxIEw2MjMsMTgwLjgyODEgTDYzMywxODAuODI4MSBMNjIzLDE3MC44MjgxICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE5IiB4PSIzOTkiIHk9IjE4Ny44OTUiPnN0b3AgbGlmZXRpbWXlrprml7blmajvvIzliKDpmaRhbGxvY2F0aW9uPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTkyLjUsMjE4LjA5MzgsMTgyLjUsMjIyLjA5MzgsMTkyLjUsMjI2LjA5MzgsMTg4LjUsMjIyLjA5MzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE4Ni41IiB4Mj0iMzgyLjUiIHkxPSIyMjIuMDkzOCIgeTI9IjIyMi4wOTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTczIiB4PSIxOTguNSIgeT0iMjE3LjAyNzgiPlJlZnJlc2ggU3VjY2VzcyBSZXNwb25zZTwvdGV4dD48IS0tTUQ1PVs4M2I5MTdiZDBmOTcyZTY1M2U4ZDgyODNjZmE2YzU3OV0KQHN0YXJ0dW1sDQpza2lucGFyYW0gTm90ZUJhY2tncm91bmRDb2xvciB3aGl0ZQ0KDQpncm91cCDnu63mnJ9hbGxvY2F0aW9uDQpjbGllbnQgLT4gc2VydmVyIDogUmVmcmVzaCBSZXF1ZXN0DQphY3RpdmF0ZSBzZXJ2ZXINCm5vdGUgbGVmdDogbGlmZXRpbWU+MO+8jOm7mOiupDYwMHMNCm5vdGUgcmlnaHQ6IHNldCBsaWZldGltZe+8jOWIt+aWsOWumuaXtuWZqA0Kc2VydmVyIC0+IGNsaWVudCA6IFJlZnJlc2ggU3VjY2VzcyBSZXNwb25zZQ0KZGVhY3RpdmF0ZSBzZXJ2ZXINCmVuZA0KDQpncm91cCBEaXNjb25uZWN0IOaWreW8gOi/nuaOpQ0KY2xpZW50IC0+IHNlcnZlciA6IFJlZnJlc2ggUmVxdWVzdA0KYWN0aXZhdGUgc2VydmVyDQpub3RlIGxlZnQ6IGxpZmV0aW1lPTANCm5vdGUgcmlnaHQ6IHN0b3AgbGlmZXRpbWXlrprml7blmajvvIzliKDpmaRhbGxvY2F0aW9uDQpzZXJ2ZXIgLT4gY2xpZW50IDogUmVmcmVzaCBTdWNjZXNzIFJlc3BvbnNlDQpkZWFjdGl2YXRlIHNlcnZlcg0KZW5kDQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjIuM2JldGEyKFVua25vd24gY29tcGlsZSB0aW1lKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogSmF2YShUTSkgU0UgUnVudGltZSBFbnZpcm9ubWVudApKVk06IEphdmEgSG90U3BvdChUTSkgNjQtQml0IFNlcnZlciBWTQpEZWZhdWx0IEVuY29kaW5nOiBVVEYtOApMYW5ndWFnZTogZW4KQ291bnRyeTogVVMKLS0+PC9nPjwvc3ZnPg=='>

<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://tools.ietf.org/id/draft-ietf-behave-turn-08.html">https://tools.ietf.org/id/draft-ietf-behave-turn-08.html</a></p>
<h3 id="ICE"><a href="#ICE" class="headerlink" title="ICE"></a>ICE</h3><h3 id="interceptor"><a href="#interceptor" class="headerlink" title="interceptor"></a>interceptor</h3><p>处理RTP/RTCP流的框架，它定义了一套处理数据包的interface，实例化函数接口必须按照指定格式进行调用，这个接口定义为<code>Interceptor</code>。</p>
<ul>
<li><p><code>BindRTCPReader</code> 和 <code>BindRTCPWriter</code> 处理incoming和outgoing的RTCP包。</p>
</li>
<li><p><code>BindLocalStream</code> 和 <code>UnbindLocalStream</code> 处理outgoing的RTP包。</p>
</li>
<li><p><code>BindRemoteStream</code> 和 <code>UnbindRemoteStream</code> 处理incoming的RTP包。</p>
</li>
</ul>
<p>chain结构体把interceptor串行在一起，并保证interceptor的执行顺序。</p>
<p>streamInfo是处理媒体流的上下文，用于在interceptor之间传递信息。</p>
<p>对外提供registry结构体，在chain上的又一层封装，暴露Add和Build接口。</p>
<p>它提供了一个<code>type NoOp struct&#123;&#125;</code>的结构体，任何需要实例化interceptor的结构体都可以继承它。</p>
<h4 id="NACK-interceptor的实现"><a href="#NACK-interceptor的实现" class="headerlink" title="NACK interceptor的实现"></a>NACK interceptor的实现</h4><p><code>GeneratorInterceptor</code> 是NACK interceptor对外提供的接口。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GeneratorInterceptor <span class="keyword">struct</span> &#123;</span><br><span class="line">	interceptor.NoOp <span class="comment">// 继承interceptor</span></span><br><span class="line">	size      <span class="keyword">uint16</span> <span class="comment">// receiveLog参数</span></span><br><span class="line">	skipLastN <span class="keyword">uint16</span> <span class="comment">// receiveLog参数</span></span><br><span class="line">	interval  time.Duration <span class="comment">// 发送RTCP包间隔</span></span><br><span class="line">	m         sync.Mutex <span class="comment">// 这个结构体的锁</span></span><br><span class="line">	wg        sync.WaitGroup <span class="comment">// RTCP writer loop结束才可以关闭的控制</span></span><br><span class="line">	<span class="built_in">close</span>     <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// 控制关闭</span></span><br><span class="line">	log       logging.LeveledLogger</span><br><span class="line"></span><br><span class="line">	receiveLogs   <span class="keyword">map</span>[<span class="keyword">uint32</span>]*receiveLog <span class="comment">// 记录了接收到的sequence number， key为SSRC</span></span><br><span class="line">	receiveLogsMu sync.Mutex <span class="comment">// receiveLog的map锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="状态控制"><a href="#状态控制" class="headerlink" title="状态控制"></a>状态控制</h5><p>实例化了interceptor的 <code>UnbindLocalStream</code>和<code>BindRemoteStream</code> 用于处理收到的RTP包， 在收到RTP包时将seq num记录在对应SSRC的receiveLog里。<br>实例化了interceptor的 <code>BindRTCPWriter</code> 用于反馈RTCP包，这里起了一个goroutine异步处理， 按定时器间隔来检查receiveLog。</p>
<h5 id="receiveLog实现"><a href="#receiveLog实现" class="headerlink" title="receiveLog实现"></a>receiveLog实现</h5><p>receiveLog是interceptor里实现NACK的重要结构体，它记录了一段连续的包是否收到的情况。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> receiveLog <span class="keyword">struct</span> &#123;</span><br><span class="line">	packets         []<span class="keyword">uint64</span> <span class="comment">// 记录RTP每个包是否收到的bitmap，使用uint64可标识64个包，因此size必须为64的整数倍</span></span><br><span class="line">	size            <span class="keyword">uint16</span> <span class="comment">// 可记录连续的RTP包的总数量</span></span><br><span class="line">	end             <span class="keyword">uint16</span> <span class="comment">// 记录收到的最后一个seq</span></span><br><span class="line">	started         <span class="keyword">bool</span> <span class="comment">// 第一个包，初始化上下文</span></span><br><span class="line">	lastConsecutive <span class="keyword">uint16</span> <span class="comment">// 记录收到的最后一个连续的seq，查找丢失包时，遍历它到end之间即可</span></span><br><span class="line">	m               sync.RWMutex <span class="comment">// 并发锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用uint64数组当bitmap，记录收到的RTP包，收到时将bit置1，删除时置0。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *receiveLog)</span> <span class="title">setReceived</span><span class="params">(seq <span class="keyword">uint16</span>)</span></span> &#123;</span><br><span class="line">	pos := seq % s.size</span><br><span class="line">	s.packets[pos/<span class="number">64</span>] |= <span class="number">1</span> &lt;&lt; (pos % <span class="number">64</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *receiveLog)</span> <span class="title">delReceived</span><span class="params">(seq <span class="keyword">uint16</span>)</span></span> &#123;</span><br><span class="line">	pos := seq % s.size</span><br><span class="line">	s.packets[pos/<span class="number">64</span>] &amp;^= <span class="number">1</span> &lt;&lt; (pos % <span class="number">64</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *receiveLog)</span> <span class="title">getReceived</span><span class="params">(seq <span class="keyword">uint16</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	pos := seq % s.size</span><br><span class="line">	<span class="keyword">return</span> (s.packets[pos/<span class="number">64</span>] &amp; (<span class="number">1</span> &lt;&lt; (pos % <span class="number">64</span>))) != <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>每收到一个包，刷新连续的最后一个位置<code>lastConsecutive</code>和记录seq最大的那个位置<code>end</code>。<br>以便在间隔时间检查需要重传包时，只需遍历从<code>lastConsecutive</code>到<code>end</code>之间的那段bit是否为0即可。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *receiveLog)</span> <span class="title">fixLastConsecutive</span><span class="params">()</span></span> &#123;</span><br><span class="line">	i := s.lastConsecutive + <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> ; i != s.end+<span class="number">1</span> &amp;&amp; s.getReceived(i); i++ &#123;</span><br><span class="line">		<span class="comment">// find all consecutive packets</span></span><br><span class="line">	&#125;</span><br><span class="line">	s.lastConsecutive = i - <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于bitmap的size标识的是一段时间内需要重传的RTP包，每收到一个新的seq时，需要判断这段buffer是否翻转，并清空从end到seq之间的记录。</p>
<h4 id="TWCC-interceptor的实现"><a href="#TWCC-interceptor的实现" class="headerlink" title="TWCC interceptor的实现"></a>TWCC interceptor的实现</h4><h4 id="SR-RR-interceptor的实现"><a href="#SR-RR-interceptor的实现" class="headerlink" title="SR/RR interceptor的实现"></a>SR/RR interceptor的实现</h4><h2 id="ion-sfu"><a href="#ion-sfu" class="headerlink" title="ion-sfu"></a>ion-sfu</h2><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><blockquote>
<p>通过设置环境变量改变pion log的日志级别，例如： export PION_LOG_TRACE=all </p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2021/05/08/2021-05-09-http-long-polling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/08/2021-05-09-http-long-polling/" class="post-title-link" itemprop="url">HttpLongPolling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-09 00:00:00" itemprop="dateCreated datePublished" datetime="2021-05-09T00:00:00+08:00">2021-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/protocol/" itemprop="url" rel="index"><span itemprop="name">protocol</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="HTTP推送技术-Push-technology"><a href="#HTTP推送技术-Push-technology" class="headerlink" title="HTTP推送技术 Push technology"></a>HTTP推送技术 Push technology</h3><p>传统的HTTP请求都是client主动发起到server的请求，若server有通知需要即时通知client时，需要推送技术。</p>
<h4 id="常规轮询-Regular-Polling"><a href="#常规轮询-Regular-Polling" class="headerlink" title="常规轮询 Regular Polling"></a>常规轮询 Regular Polling</h4><p>每隔一段时间pull/get消息。</p>
<ul>
<li>没有消息时浪费资源。</li>
<li>有消息时不能即时推送。</li>
</ul>
<h4 id="长轮询-Long-Polling"><a href="#长轮询-Long-Polling" class="headerlink" title="长轮询 Long Polling"></a>长轮询 Long Polling</h4><ol>
<li><p>请求</p>
<p>client发起请求并把keepalive时间设的较长，服务器收到消息并不立即返回，而是hold一段时间。</p>
</li>
<li><p>响应</p>
<p>当有消息推送时，server立即返回消息。或server的connection hang timeout时，返回消息。server返回消息后，将连接关闭。</p>
</li>
<li><p>循环</p>
<p> client收到response后，应立即再次发起请求。</p>
</li>
</ol>
<h3 id="Long-Polling-vs-Websocket"><a href="#Long-Polling-vs-Websocket" class="headerlink" title="Long Polling vs Websocket"></a>Long Polling vs Websocket</h3><p>Long Polling并不是一种全新的协议，而是基于XMLHttpRequest实现了一种推送机制。最大的优点是过渡期的兼容性好，client无需新增协议，容易适配。<br>同个client若发起多个request连接，消息只返回一次，应通过本地缓存共享推送消息。</p>
<p>websocket协议相对较晚出现，需要client和server端都支持websocket协议，尽管它的握手还是基于HTTP协议，但它在HTTP协议上实现了全双工通信。</p>
<p>websocket几乎解决了Long Polling的所有缺点，只是被断开后不能自恢复。</p>
<h3 id="Apollo在Long-polling的实践"><a href="#Apollo在Long-polling的实践" class="headerlink" title="Apollo在Long polling的实践"></a>Apollo在Long polling的实践</h3><p>Apollo是携程开源的配置中心，提供了带缓存和不带缓存的pull接口，和long polling即时变更推送接口。</p>
<p>为了避免long polling机制的缺陷，使用了版本号等方案。</p>
<ul>
<li><p>Long polling获取的消息时，需要带上本地缓存的notificationId，server端判断client带过来的notificationId是否为最新，若需要更新则立即返回消息，否则等配置有更新才会返回，返回消息携带notificationId，client端更新缓存。这样做的好处是，即使中间断开连接，恢复连接后也可以对比本地是否需要更新配置信息。</p>
</li>
<li><p>client使用pull接口获取配置时，可填参数IP表示client的唯一Id，当需要灰度推送时，根据client携带的IP判断是否给它灰度配置。这样做的好处是，使用逻辑上的Id（IP），相同IP的client可以获取到相同的配置。</p>
</li>
<li><p>client使用pull接口获取配置时，可填参数releaseKey。Apollo每次发布配置时，会为新版本的配置生成releaseKey，使用常规轮询时server端无需每次都查表，可根据releaseKey判断是否需要读取配置。client也无需每次都更新本地缓存的配置。</p>
</li>
</ul>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI1ODRweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjY4MnB4O2hlaWdodDo1ODRweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA2ODIgNTg0IiB3aWR0aD0iNjgycHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48ZWxsaXBzZSBjeD0iNDExLjM3NSIgY3k9IjIwIiBmaWxsPSIjMjIyMjIyIiByeD0iMTAiIHJ5PSIxMCIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSIzMjEuODc1LDEwMy45Njg4LDUwMC44NzUsMTAzLjk2ODgsNTEyLjg3NSwxMTUuOTY4OCw1MDAuODc1LDEyNy45Njg4LDMyMS44NzUsMTI3Ljk2ODgsMzA5Ljg3NSwxMTUuOTY4OCwzMjEuODc1LDEwMy45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzkiIHg9IjMyMS44NzUiIHk9IjExOS43NzY5Ij5BcG9sbG8gY29uZmlnIG5vcm1hbCByZXNwb25zZT88L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjEiIHg9IjI4OC44NzUiIHk9IjExMy4zNzQ1Ij55ZXM8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQiIHg9IjUxMi44NzUiIHk9IjExMy4zNzQ1Ij5ubzwvdGV4dD48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjIwOC4yNSwxMzcuOTY4OCwzMDYuMjUsMTM3Ljk2ODgsMzE4LjI1LDE0OS45Njg4LDMwNi4yNSwxNjEuOTY4OCwyMDguMjUsMTYxLjk2ODgsMTk2LjI1LDE0OS45Njg4LDIwOC4yNSwxMzcuOTY4OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTgiIHg9IjIwOC4yNSIgeT0iMTUzLjc3NjkiPmh0dHAgc3RhdHVzIGNvZGU/PC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDYiIHg9IjEwNC41IiB5PSIxOTcuNTc4MSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMiIgeD0iMTE4LjUiIHk9IjIxOC43MTY4Ij51cGRhdGUgbm90aWZpY2F0aW9uSWQ8L3RleHQ+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSIxMDcsMjUxLjU0NjksMjQ4LDI1MS41NDY5LDI2MCwyNjMuNTQ2OSwyNDgsMjc1LjU0NjksMTA3LDI3NS41NDY5LDk1LDI2My41NDY5LDEwNywyNTEuNTQ2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQxIiB4PSIxMDciIHk9IjI2Ny4zNTUiPkhUVFAgZ2V0IGNvbmZpZyBuZXdlc3Q/PC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzgiIHg9IjExIiB5PSIzMTguMzUxNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNCIgeD0iMjUiIHk9IjMzOS40OTAyIj51cGRhdGUgbG9jYWwgY2FjaGU8L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijg3IiB4PSIyMzEuNSIgeT0iMzE4LjM1MTYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MyIgeD0iMjQ1LjUiIHk9IjMzOS40OTAyIj5ubyBjaGFuZ2U8L3RleHQ+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSIxNzcuNSwzOTkuMjQyMiwxNzcuNSwzOTkuMjQyMiwxODkuNSw0MTEuMjQyMiwxNzcuNSw0MjMuMjQyMiwxNzcuNSw0MjMuMjQyMiwxNjUuNSw0MTEuMjQyMiwxNzcuNSwzOTkuMjQyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijg3IiB4PSIzMzguNSIgeT0iMTk3LjU3ODEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MyIgeD0iMzUyLjUiIHk9IjIxOC43MTY4Ij5ubyBjaGFuZ2U8L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU2IiB4PSI0NDUuNSIgeT0iMTk3LjU3ODEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzMiIgeD0iNDU5LjUiIHk9IjIxOC43MTY4Ij5vdGhlcjwvdGV4dD48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjI1Ny4yNSw0MzMuMjQyMiwyNTcuMjUsNDMzLjI0MjIsMjY5LjI1LDQ0NS4yNDIyLDI1Ny4yNSw0NTcuMjQyMiwyNTcuMjUsNDU3LjI0MjIsMjQ1LjI1LDQ0NS4yNDIyLDI1Ny4yNSw0MzMuMjQyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijg0IiB4PSI1MjMuNSIgeT0iMTM3Ljk2ODgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2MCIgeD0iNTM3LjUiIHk9IjE1OS4xMDc0Ij5IdHRwIGVycm9yPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiNGMUYxRjEiIHBvaW50cz0iNDExLjM3NSw0NjMuMjQyMiw0MjMuMzc1LDQ3NS4yNDIyLDQxMS4zNzUsNDg3LjI0MjIsMzk5LjM3NSw0NzUuMjQyMiw0MTEuMzc1LDQ2My4yNDIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iODciIHg9IjM2Ny44NzUiIHk9IjUwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjciIHg9IjM3Ny44NzUiIHk9IjcxLjEzODciPkxvbmdQb2xsaW5nPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiNGMUYxRjEiIHBvaW50cz0iNDExLjM3NSw1MDcuMjQyMiw0MTEuMzc1LDUwNy4yNDIyLDQyMy4zNzUsNTE5LjI0MjIsNDExLjM3NSw1MzEuMjQyMiw0MTEuMzc1LDUzMS4yNDIyLDM5OS4zNzUsNTE5LjI0MjIsNDExLjM3NSw1MDcuMjQyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU0IiB4PSI2MTcuNSIgeT0iMzQ1LjI3MzQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNCIgeD0iNjI3LjUiIHk9IjM2Ni40MTIxIj5zbGVlcDwvdGV4dD48ZWxsaXBzZSBjeD0iNDExLjM3NSIgY3k9IjU2Mi4yNDIyIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7ZmlsbDpub25lOyIvPjxlbGxpcHNlIGN4PSI0MTEuMzc1IiBjeT0iNTYyLjI0MjIiIGZpbGw9IiMyMjIyMjIiIHJ4PSI2IiByeT0iNiIgc3R5bGU9InN0cm9rZTojMTExMTExO3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iOTUiIHgyPSI4MCIgeTE9IjI2My41NDY5IiB5Mj0iMjYzLjU0NjkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI4MCIgeDI9IjgwIiB5MT0iMjYzLjU0NjkiIHkyPSIzMTguMzUxNiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzYsMzA4LjM1MTYsODAsMzE4LjM1MTYsODQsMzA4LjM1MTYsODAsMzEyLjM1MTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIxIiB4PSI4MCIgeT0iMjk2Ljg1MTYiPjIwMDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyNjAiIHgyPSIyNzUiIHkxPSIyNjMuNTQ2OSIgeTI9IjI2My41NDY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjc1IiB4Mj0iMjc1IiB5MT0iMjYzLjU0NjkiIHkyPSIzMTguMzUxNiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjcxLDMwOC4zNTE2LDI3NSwzMTguMzUxNiwyNzksMzA4LjM1MTYsMjc1LDMxMi4zNTE2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMSIgeD0iMjc1IiB5PSIyOTYuODUxNiI+MzA0PC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjgwIiB4Mj0iODAiIHkxPSIzNTIuMzIwMyIgeTI9IjQxMS4yNDIyIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iODAiIHgyPSIxNjUuNSIgeTE9IjQxMS4yNDIyIiB5Mj0iNDExLjI0MjIiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1NS41LDQwNy4yNDIyLDE2NS41LDQxMS4yNDIyLDE1NS41LDQxNS4yNDIyLDE1OS41LDQxMS4yNDIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyNzUiIHgyPSIyNzUiIHkxPSIzNTIuMzIwMyIgeTI9IjQxMS4yNDIyIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjc1IiB4Mj0iMTg5LjUiIHkxPSI0MTEuMjQyMiIgeTI9IjQxMS4yNDIyIi8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxOTkuNSw0MDcuMjQyMiwxODkuNSw0MTEuMjQyMiwxOTkuNSw0MTUuMjQyMiwxOTUuNSw0MTEuMjQyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMTc3LjUiIHgyPSIxNzcuNSIgeTE9IjIzMS41NDY5IiB5Mj0iMjUxLjU0NjkiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3My41LDI0MS41NDY5LDE3Ny41LDI1MS41NDY5LDE4MS41LDI0MS41NDY5LDE3Ny41LDI0NS41NDY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxOTYuMjUiIHgyPSIxNzcuNSIgeTE9IjE0OS45Njg4IiB5Mj0iMTQ5Ljk2ODgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxNzcuNSIgeDI9IjE3Ny41IiB5MT0iMTQ5Ljk2ODgiIHkyPSIxOTcuNTc4MSIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTczLjUsMTg3LjU3ODEsMTc3LjUsMTk3LjU3ODEsMTgxLjUsMTg3LjU3ODEsMTc3LjUsMTkxLjU3ODEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIxIiB4PSIxNzcuNSIgeT0iMTc3LjU4MTUiPjIwMDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIzMTguMjUiIHgyPSI0NzMuNSIgeTE9IjE0OS45Njg4IiB5Mj0iMTQ5Ljk2ODgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0NzMuNSIgeDI9IjQ3My41IiB5MT0iMTQ5Ljk2ODgiIHkyPSIxOTcuNTc4MSIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDY5LjUsMTg3LjU3ODEsNDczLjUsMTk3LjU3ODEsNDc3LjUsMTg3LjU3ODEsNDczLjUsMTkxLjU3ODEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMwIiB4PSI0NzMuNSIgeT0iMTc3LjU4MTUiPm90aGVyPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjM4MiIgeDI9IjM4MiIgeTE9IjE0OS45Njg4IiB5Mj0iMTk3LjU3ODEiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM3OCwxODcuNTc4MSwzODIsMTk3LjU3ODEsMzg2LDE4Ny41NzgxLDM4MiwxOTEuNTc4MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjEiIHg9IjM4MiIgeT0iMTcyLjU4MTUiPjMwNDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxNzcuNSIgeDI9IjE3Ny41IiB5MT0iNDIzLjI0MjIiIHkyPSI0NDUuMjQyMiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE3Ny41IiB4Mj0iMjQ1LjI1IiB5MT0iNDQ1LjI0MjIiIHkyPSI0NDUuMjQyMiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjM1LjI1LDQ0MS4yNDIyLDI0NS4yNSw0NDUuMjQyMiwyMzUuMjUsNDQ5LjI0MjIsMjM5LjI1LDQ0NS4yNDIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0NzMuNSIgeDI9IjQ3My41IiB5MT0iMjMxLjU0NjkiIHkyPSI0NDUuMjQyMiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQ3My41IiB4Mj0iMjY5LjI1IiB5MT0iNDQ1LjI0MjIiIHkyPSI0NDUuMjQyMiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjc5LjI1LDQ0MS4yNDIyLDI2OS4yNSw0NDUuMjQyMiwyNzkuMjUsNDQ5LjI0MjIsMjc1LjI1LDQ0NS4yNDIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIzODIiIHgyPSIzODIiIHkxPSIyMzEuNTQ2OSIgeTI9IjQ0NS4yNDIyIi8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNzgsNDM1LjI0MjIsMzgyLDQ0NS4yNDIyLDM4Niw0MzUuMjQyMiwzODIsNDM5LjI0MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjMwOS44NzUiIHgyPSIyNTcuMjUiIHkxPSIxMTUuOTY4OCIgeTI9IjExNS45Njg4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjU3LjI1IiB4Mj0iMjU3LjI1IiB5MT0iMTE1Ljk2ODgiIHkyPSIxMzcuOTY4OCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjUzLjI1LDEyNy45Njg4LDI1Ny4yNSwxMzcuOTY4OCwyNjEuMjUsMTI3Ljk2ODgsMjU3LjI1LDEzMS45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI1MTIuODc1IiB4Mj0iNTY1LjUiIHkxPSIxMTUuOTY4OCIgeTI9IjExNS45Njg4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNTY1LjUiIHgyPSI1NjUuNSIgeTE9IjExNS45Njg4IiB5Mj0iMTM3Ljk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU2MS41LDEyNy45Njg4LDU2NS41LDEzNy45Njg4LDU2OS41LDEyNy45Njg4LDU2NS41LDEzMS45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyNTcuMjUiIHgyPSIyNTcuMjUiIHkxPSI0NTcuMjQyMiIgeTI9IjQ3NS4yNDIyIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjU3LjI1IiB4Mj0iMzk5LjM3NSIgeTE9IjQ3NS4yNDIyIiB5Mj0iNDc1LjI0MjIiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM4OS4zNzUsNDcxLjI0MjIsMzk5LjM3NSw0NzUuMjQyMiwzODkuMzc1LDQ3OS4yNDIyLDM5My4zNzUsNDc1LjI0MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjU2NS41IiB4Mj0iNTY1LjUiIHkxPSIxNzEuOTM3NSIgeTI9IjQ3NS4yNDIyIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNTY1LjUiIHgyPSI0MjMuMzc1IiB5MT0iNDc1LjI0MjIiIHkyPSI0NzUuMjQyMiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDMzLjM3NSw0NzEuMjQyMiw0MjMuMzc1LDQ3NS4yNDIyLDQzMy4zNzUsNDc5LjI0MjIsNDI5LjM3NSw0NzUuMjQyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDExLjM3NSIgeDI9IjQxMS4zNzUiIHkxPSI4My45Njg4IiB5Mj0iMTAzLjk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQwNy4zNzUsOTMuOTY4OCw0MTEuMzc1LDEwMy45Njg4LDQxNS4zNzUsOTMuOTY4OCw0MTEuMzc1LDk3Ljk2ODgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQyMy4zNzUiIHgyPSI2NDQuNSIgeTE9IjUxOS4yNDIyIiB5Mj0iNTE5LjI0MjIiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI2NDQuNSIgeDI9IjY0NC41IiB5MT0iMzc5LjI0MjIiIHkyPSI1MTkuMjQyMiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjQwLjUsMzg5LjI0MjIsNjQ0LjUsMzc5LjI0MjIsNjQ4LjUsMzg5LjI0MjIsNjQ0LjUsMzg1LjI0MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjY0NC41IiB4Mj0iNjQ0LjUiIHkxPSI2Ni45ODQ0IiB5Mj0iMzQ1LjI3MzQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI2NDQuNSIgeDI9IjQ1NC44NzUiIHkxPSI2Ni45ODQ0IiB5Mj0iNjYuOTg0NCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDY0Ljg3NSw2Mi45ODQ0LDQ1NC44NzUsNjYuOTg0NCw0NjQuODc1LDcwLjk4NDQsNDYwLjg3NSw2Ni45ODQ0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0MTEuMzc1IiB4Mj0iNDExLjM3NSIgeTE9IjQ4Ny4yNDIyIiB5Mj0iNTA3LjI0MjIiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQwNy4zNzUsNDk3LjI0MjIsNDExLjM3NSw1MDcuMjQyMiw0MTUuMzc1LDQ5Ny4yNDIyLDQxMS4zNzUsNTAxLjI0MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQxMS4zNzUiIHgyPSI0MTEuMzc1IiB5MT0iMzAiIHkyPSI1MCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDA3LjM3NSw0MCw0MTEuMzc1LDUwLDQxNS4zNzUsNDAsNDExLjM3NSw0NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDExLjM3NSIgeDI9IjQxMS4zNzUiIHkxPSI1MzEuMjQyMiIgeTI9IjU1MS4yNDIyIi8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MDcuMzc1LDU0MS4yNDIyLDQxMS4zNzUsNTUxLjI0MjIsNDE1LjM3NSw1NDEuMjQyMiw0MTEuMzc1LDU0NS4yNDIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48IS0tTUQ1PVs1NmFmZjNlYmQxZDcwMjljMzcxMTNlNThkYjM0MTAzYV0KQHN0YXJ0dW1sDQpzdGFydCANCg0KcmVwZWF0IDpMb25nUG9sbGluZzsNCmlmIChBcG9sbG8gY29uZmlnIG5vcm1hbCByZXNwb25zZT8pIHRoZW4gKHllcykNCiAgICBzd2l0Y2ggKGh0dHAgc3RhdHVzIGNvZGU/KSANCiAgICBjYXNlICgyMDApDQogICAgICAgIDogdXBkYXRlIG5vdGlmaWNhdGlvbklkOw0KICAgICAgICBzd2l0Y2ggKEhUVFAgZ2V0IGNvbmZpZyBuZXdlc3Q/KQ0KICAgICAgICAgICAgY2FzZSAoMjAwKQ0KICAgICAgICAgICAgICAgIDogdXBkYXRlIGxvY2FsIGNhY2hlOw0KICAgICAgICAgICAgY2FzZSAoMzA0KQ0KICAgICAgICAgICAgICAgIDogbm8gY2hhbmdlOw0KICAgICAgICBlbmRzd2l0Y2gNCiAgICBjYXNlICgzMDQpDQogICAgICAgIDogbm8gY2hhbmdlOw0KICAgIGNhc2UgKG90aGVyKQ0KICAgICAgICA6IG90aGVyOw0KICAgIGVuZHN3aXRjaA0KZWxzZSAobm8pDQogICAgOiBIdHRwIGVycm9yOw0KZW5kaWYNCg0KYmFja3dhcmQgOnNsZWVwOw0KcmVwZWF0IHdoaWxlICgpDQpzdG9wDQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjIuM2JldGEyKFVua25vd24gY29tcGlsZSB0aW1lKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogSmF2YShUTSkgU0UgUnVudGltZSBFbnZpcm9ubWVudApKVk06IEphdmEgSG90U3BvdChUTSkgNjQtQml0IFNlcnZlciBWTQpEZWZhdWx0IEVuY29kaW5nOiBVVEYtOApMYW5ndWFnZTogZW4KQ291bnRyeTogVVMKLS0+PC9nPjwvc3ZnPg=='>

<ul>
<li><p>流程图不需要考虑很严谨的逻辑，因为有版本号，即使中间有异常，下次轮询的时候也可以恢复。</p>
</li>
<li><p>做好降级策略，定期轮询，防止路由策略等导致的long polling服务不可用。</p>
</li>
</ul>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a target="_blank" rel="noopener" href="https://ably.com/blog/websockets-vs-long-polling">https://ably.com/blog/websockets-vs-long-polling</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2021/04/09/2021-04-10-mediasoup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/09/2021-04-10-mediasoup/" class="post-title-link" itemprop="url">Mediasoup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-10 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-10T00:00:00+08:00">2021-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/" itemprop="url" rel="index"><span itemprop="name">media</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mediasoup"><a href="#mediasoup" class="headerlink" title="mediasoup"></a>mediasoup</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>v3版本源码实现了SFU的基本转发功能，由C++部分的worker和TS部分的信令组成。这两部分之间用Unix domain socket通信，是进程之间的全双工通信方式，基于文件系统，不需要走协议栈，因此必须同机部署。</p>
<p><strong>peer</strong></p>
<p>逻辑层抽象，代表了通话的成员。</p>
<p><strong>room</strong> </p>
<p>逻辑层通常和router绑定，代表了通话的房间。</p>
<p><strong>router</strong></p>
<p>模型层代表了媒体流转发的单元，一个router内包含了transport, producer, consumer这些模型的实例。<br>记录了transport和流的包含关系，还有producer和consumer的映射关系，主要负责从transport中获取数据包和producer/consumer的流媒体转发。</p>
<p><strong>transport</strong></p>
<p>数据层抽象，代表了一路socket层面的数据流，可以承载多个RTP stream。通常一个典型的通话里，上行和下行需要分别建立两个socket连接，就是两个transport。客户端与mediasoup之间的transport通常是<code>webrtcTransport</code>。mediasoup之间的routers也可以建立transport实现级联关系，通常是<code>pipeTransport</code>。发给GStreamer和ffmepg的为<code>plainTransport</code>。</p>
<p>基于socket的webrtcTransport的ICE只支持Lite模式，一方面是因为作者并非将它设计为商业用途，另一方面mediasoup的STUN把自己也当成一个host，简单实现了协议功能。</p>
<p><strong>producer</strong></p>
<p>媒体流的生产者。</p>
<p><strong>consumer</strong></p>
<p>媒体流的消费者。</p>
<h2 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h2><p><a href="/images/svg/mediasoup.svg">mediasoup</a><br><img src="/images/svg/mediasoup.svg"></p>
<h2 id="实现协议"><a href="#实现协议" class="headerlink" title="实现协议"></a>实现协议</h2><p>WebRTC实现连接的ICE和能力协商的SDP都属于描述性协议，并不严格规定具体的实现。因此信令层面由mediasoup官方提供的<a target="_blank" rel="noopener" href="https://github.com/versatica/mediasoup-demo">demo</a>和<a target="_blank" rel="noopener" href="https://github.com/versatica/libmediasoupclient">client-cpp</a>,<a target="_blank" rel="noopener" href="https://github.com/versatica/mediasoup-client">client-js</a>等实现具体基于webrtc的调用，这部分代码主要在demo。数据层则是实现了RTP/RTCP协议的基本传输和反馈能力，这部分代码主要在worker。client-cpp提供了调用webrtc-native的API，client-js则是调用支持webrtc的浏览器端提供的API。client和demo/worker通过私有信令和标准协议通信实现了基本的RTC功能。</p>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI5MTRweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjkyMnB4O2hlaWdodDo5MTRweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA5MjIgOTE0IiB3aWR0aD0iOTIycHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI0MzcuNSIgeT0iOTYuNTYyNSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iOTMuMzk4NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjQzNy41IiB5PSIxODMuOTYwOSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iNjEuMjY1NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjQzNy41IiB5PSIzMzUuNjI1Ii8+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSI5My4zOTg0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSIxMCIgeD0iNDM3LjUiIHk9IjUyMi40MjE5Ii8+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIxMTkuNTMxMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjQzNy41IiB5PSI2NzQuMDg1OSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMzIuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY2Mi41IiB5PSIyMTYuMDkzOCIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMzIuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY2Mi41IiB5PSIzOTYuODkwNiIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMzIuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY2Mi41IiB5PSI1NTQuNTU0NyIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMjkuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY2Mi41IiB5PSI3MDMuMjE4OCIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMzIuMTMyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjY2Mi41IiB5PSI3OTMuNjE3MiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIzNyIgeDI9IjM3IiB5MT0iMzYuMjk2OSIgeTI9Ijg3OC44ODI4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjE2MyIgeDI9IjE2MyIgeTE9IjM2LjI5NjkiIHkyPSI4NzguODgyOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSI0NDIiIHgyPSI0NDIiIHkxPSIzNi4yOTY5IiB5Mj0iODc4Ljg4MjgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iNjY3LjUiIHgyPSI2NjcuNSIgeTE9IjM2LjI5NjkiIHkyPSI4NzguODgyOCIvPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjUiIHg9IjUiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MSIgeD0iMTIiIHk9IjI0Ljk5NTEiPndlYnJ0YzwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjY1IiB4PSI1IiB5PSI4NzcuODgyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUxIiB4PSIxMiIgeT0iODk3Ljg3NzkiPndlYnJ0YzwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1IiB4PSIxMzYiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MSIgeD0iMTQzIiB5PSIyNC45OTUxIj5jbGllbnQ8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1NSIgeD0iMTM2IiB5PSI4NzcuODgyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxIiB4PSIxNDMiIHk9Ijg5Ny44Nzc5Ij5jbGllbnQ8L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1NSIgeD0iNDE1IiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEiIHg9IjQyMiIgeT0iMjQuOTk1MSI+ZGVtbzwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU1IiB4PSI0MTUiIHk9Ijg3Ny44ODI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDEiIHg9IjQyMiIgeT0iODk3Ljg3NzkiPmRlbW88L3RleHQ+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI5MiIgeD0iNjIxLjUiIHk9IjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3OCIgeD0iNjI4LjUiIHk9IjI0Ljk5NTEiPm1lZGlhc291cDwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjkyIiB4PSI2MjEuNSIgeT0iODc3Ljg4MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3OCIgeD0iNjI4LjUiIHk9Ijg5Ny44Nzc5Ij5tZWRpYXNvdXA8L3RleHQ+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgaGVpZ2h0PSIyOS4xMzI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHdpZHRoPSIxMCIgeD0iNDM3LjUiIHk9Ijk2LjU2MjUiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjkzLjM5ODQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI0MzcuNSIgeT0iMTgzLjk2MDkiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjYxLjI2NTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI0MzcuNSIgeT0iMzM1LjYyNSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iOTMuMzk4NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iMTAiIHg9IjQzNy41IiB5PSI1MjIuNDIxOSIvPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGhlaWdodD0iMTE5LjUzMTMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI0MzcuNSIgeT0iNjc0LjA4NTkiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMyLjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NjIuNSIgeT0iMjE2LjA5MzgiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMyLjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NjIuNSIgeT0iMzk2Ljg5MDYiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMyLjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NjIuNSIgeT0iNTU0LjU1NDciLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjI5LjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NjIuNSIgeT0iNzAzLjIxODgiLz48cmVjdCBmaWxsPSIjRkZGRkZGIiBoZWlnaHQ9IjMyLjEzMjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgd2lkdGg9IjEwIiB4PSI2NjIuNSIgeT0iNzkzLjYxNzIiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1MS41LDYzLjQyOTcsMTYxLjUsNjcuNDI5NywxNTEuNSw3MS40Mjk3LDE1NS41LDY3LjQyOTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Mi4wLDIuMDsiIHgxPSIzNy41IiB4Mj0iMTU3LjUiIHkxPSI2Ny40Mjk3IiB5Mj0iNjcuNDI5NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMiIgeD0iNDQuNSIgeT0iNjIuMzYzOCI+Z2V0TWVkaWFEZXZpY2U8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MjUuNSw5Mi41NjI1LDQzNS41LDk2LjU2MjUsNDI1LjUsMTAwLjU2MjUsNDI5LjUsOTYuNTYyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMTYzLjUiIHgyPSI0MzEuNSIgeTE9Ijk2LjU2MjUiIHkyPSI5Ni41NjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTU5IiB4PSIxNzAuNSIgeT0iOTEuNDk2NiI+Z2V0Um91dGVyUnRwQ2FwYWJpbGl0aWVzPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc0LjUsMTIxLjY5NTMsMTY0LjUsMTI1LjY5NTMsMTc0LjUsMTI5LjY5NTMsMTcwLjUsMTI1LjY5NTMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE2OC41IiB4Mj0iNDQxLjUiIHkxPSIxMjUuNjk1MyIgeTI9IjEyNS42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTg3IiB4PSIxODAuNSIgeT0iMTIwLjYyOTQiPui/lOWbnm1lZGlhc291cOaUr+aMgeeahFJUUOiDveWKmzwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ4LjUsMTUwLjgyODEsMzguNSwxNTQuODI4MSw0OC41LDE1OC44MjgxLDQ0LjUsMTU0LjgyODEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Mi4wLDIuMDsiIHgxPSI0Mi41IiB4Mj0iMTYyLjUiIHkxPSIxNTQuODI4MSIgeTI9IjE1NC44MjgxIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTAiIHg9IjU0LjUiIHk9IjE0OS43NjIyIj5zZXQgU0RQPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDI1LjUsMTc5Ljk2MDksNDM1LjUsMTgzLjk2MDksNDI1LjUsMTg3Ljk2MDksNDI5LjUsMTgzLjk2MDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE2My41IiB4Mj0iNDMxLjUiIHkxPSIxODMuOTYwOSIgeTI9IjE4My45NjA5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE4IiB4PSIxNzAuNSIgeT0iMTc4Ljg5NSI+Y3JlYXRlV2ViUnRjVHJhbnNwb3J0KHVwL2Rvd24pPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjUwLjUsMjEyLjA5MzgsNjYwLjUsMjE2LjA5MzgsNjUwLjUsMjIwLjA5MzgsNjU0LjUsMjE2LjA5MzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjQ0Ny41IiB4Mj0iNjU2LjUiIHkxPSIyMTYuMDkzOCIgeTI9IjIxNi4wOTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTk2IiB4PSI0NTQuNSIgeT0iMjExLjAyNzgiPnJvdXRlci5jcmVhdGVXZWJSdGNUcmFuc3BvcnQ8L3RleHQ+PHBhdGggZD0iTTY3NywxOTYuOTYwOSBMNjc3LDIyMS45NjA5IEw4NTEsMjIxLjk2MDkgTDg1MSwyMDYuOTYwOSBMODQxLDE5Ni45NjA5IEw2NzcsMTk2Ljk2MDkgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNODQxLDE5Ni45NjA5IEw4NDEsMjA2Ljk2MDkgTDg1MSwyMDYuOTYwOSBMODQxLDE5Ni45NjA5ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUzIiB4PSI2ODMiIHk9IjIxNC4wMjc4Ij7liJvlu7rkuIrkuIvooYzkuKTkuKpUcmFuc3BvcnQ8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0NTguNSwyNDQuMjI2Niw0NDguNSwyNDguMjI2Niw0NTguNSwyNTIuMjI2Niw0NTQuNSwyNDguMjI2NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDUyLjUiIHgyPSI2NjYuNSIgeTE9IjI0OC4yMjY2IiB5Mj0iMjQ4LjIyNjYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjQ2NC41IiB5PSIyNDMuMTYwNiI+SUNFL0RUTFMvU0NUUOWPguaVsDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3NC41LDI3My4zNTk0LDE2NC41LDI3Ny4zNTk0LDE3NC41LDI4MS4zNTk0LDE3MC41LDI3Ny4zNTk0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxNjguNSIgeDI9IjQ0MS41IiB5MT0iMjc3LjM1OTQiIHkyPSIyNzcuMzU5NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMCIgeD0iMTgwLjUiIHk9IjI3Mi4yOTM1Ij5JQ0UvRFRMUy9TQ1RQ5Y+C5pWwPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDguNSwzMDIuNDkyMiwzOC41LDMwNi40OTIyLDQ4LjUsMzEwLjQ5MjIsNDQuNSwzMDYuNDkyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjQyLjUiIHgyPSIxNjIuNSIgeTE9IjMwNi40OTIyIiB5Mj0iMzA2LjQ5MjIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MCIgeD0iNTQuNSIgeT0iMzAxLjQyNjMiPnNldCBTRFA8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MjUuNSwzMzEuNjI1LDQzNS41LDMzNS42MjUsNDI1LjUsMzM5LjYyNSw0MjkuNSwzMzUuNjI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxNjMuNSIgeDI9IjQzMS41IiB5MT0iMzM1LjYyNSIgeTI9IjMzNS42MjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMiIgeD0iMTcwLjUiIHk9IjMzMC41NTkxIj5qb2luPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc0LjUsMzYwLjc1NzgsMTY0LjUsMzY0Ljc1NzgsMTc0LjUsMzY4Ljc1NzgsMTcwLjUsMzY0Ljc1NzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE2OC41IiB4Mj0iNDM2LjUiIHkxPSIzNjQuNzU3OCIgeTI9IjM2NC43NTc4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzQiIHg9IjE4MC41IiB5PSIzNTkuNjkxOSI+b3RoZXIgcGVlcnM8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NTAuNSwzOTIuODkwNiw2NjAuNSwzOTYuODkwNiw2NTAuNSw0MDAuODkwNiw2NTQuNSwzOTYuODkwNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDQyLjUiIHgyPSI2NTYuNSIgeTE9IjM5Ni44OTA2IiB5Mj0iMzk2Ljg5MDYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjIiIHg9IjQ0OS41IiB5PSIzOTEuODI0NyI+dHJhbnNwb3J0LmNvbnN1bWU8L3RleHQ+PHBhdGggZD0iTTY3NywzNzcuNzU3OCBMNjc3LDQwMi43NTc4IEw5MTUsNDAyLjc1NzggTDkxNSwzODcuNzU3OCBMOTA1LDM3Ny43NTc4IEw2NzcsMzc3Ljc1NzggIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNOTA1LDM3Ny43NTc4IEw5MDUsMzg3Ljc1NzggTDkxNSwzODcuNzU3OCBMOTA1LDM3Ny43NTc4ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE3IiB4PSI2ODMiIHk9IjM5NC44MjQ3Ij7lnKhUcmFuc3BvcnTkuIrlu7rnq4tjb25zdW1lcueahOaYoOWwhDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ1My41LDQyNS4wMjM0LDQ0My41LDQyOS4wMjM0LDQ1My41LDQzMy4wMjM0LDQ0OS41LDQyOS4wMjM0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0NDcuNSIgeDI9IjY2Ni41IiB5MT0iNDI5LjAyMzQiIHkyPSI0MjkuMDIzNCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2MCIgeD0iNDU5LjUiIHk9IjQyMy45NTc1Ij5wcm9kdWNlcuWSjGNvbnN1bWVy54q25oCBPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc0LjUsNDU3LjE1NjMsMTY0LjUsNDYxLjE1NjMsMTc0LjUsNDY1LjE1NjMsMTcwLjUsNDYxLjE1NjMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE2OC41IiB4Mj0iNDQxLjUiIHkxPSI0NjEuMTU2MyIgeTI9IjQ2MS4xNTYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjI5IiB4PSIxODAuNSIgeT0iNDU2LjA5MDMiPuWPkee7meiHquW3sW5ld0NvbnN1bWVyKGF1ZGlvL3ZpZGVvKTwvdGV4dD48cGF0aCBkPSJNNDQ3LDQ0Mi4wMjM0IEw0NDcsNDY3LjAyMzQgTDcxNSw0NjcuMDIzNCBMNzE1LDQ1Mi4wMjM0IEw3MDUsNDQyLjAyMzQgTDQ0Nyw0NDIuMDIzNCAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik03MDUsNDQyLjAyMzQgTDcwNSw0NTIuMDIzNCBMNzE1LDQ1Mi4wMjM0IEw3MDUsNDQyLjAyMzQgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNDciIHg9IjQ1MyIgeT0iNDU5LjA5MDMiPuaKiuaWsOi/m+aIv+aIkOWRmOW9k+WBmuWFtuS7luW3sue7j+i/m+aIv+aIkOWRmOeahOS4i+ihjDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE1MS41LDQ4OS4yODkxLDE2MS41LDQ5My4yODkxLDE1MS41LDQ5Ny4yODkxLDE1NS41LDQ5My4yODkxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMzcuNSIgeDI9IjE1Ny41IiB5MT0iNDkzLjI4OTEiIHkyPSI0OTMuMjg5MSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU5IiB4PSI0NC41IiB5PSI0ODguMjIzMSI+RFRMU+WPguaVsDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQyNS41LDUxOC40MjE5LDQzNS41LDUyMi40MjE5LDQyNS41LDUyNi40MjE5LDQyOS41LDUyMi40MjE5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxNjMuNSIgeDI9IjQzMS41IiB5MT0iNTIyLjQyMTkiIHkyPSI1MjIuNDIxOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyOCIgeD0iMTcwLjUiIHk9IjUxNy4zNTYiPmNvbm5lY3RXZWJSdGNUcmFuc3BvcnQodXAvZG93bik8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NTAuNSw1NTAuNTU0Nyw2NjAuNSw1NTQuNTU0Nyw2NTAuNSw1NTguNTU0Nyw2NTQuNSw1NTQuNTU0NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDQ3LjUiIHgyPSI2NTYuNSIgeTE9IjU1NC41NTQ3IiB5Mj0iNTU0LjU1NDciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTQiIHg9IjQ1NC41IiB5PSI1NDkuNDg4OCI+dHJhbnNwb3J0LmNvbm5lY3Q8L3RleHQ+PHBhdGggZD0iTTY3Nyw1MzUuNDIxOSBMNjc3LDU2MC40MjE5IEw3ODMsNTYwLjQyMTkgTDc4Myw1NDUuNDIxOSBMNzczLDUzNS40MjE5IEw2NzcsNTM1LjQyMTkgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzczLDUzNS40MjE5IEw3NzMsNTQ1LjQyMTkgTDc4Myw1NDUuNDIxOSBMNzczLDUzNS40MjE5ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODUiIHg9IjY4MyIgeT0iNTUyLjQ4ODgiPuiuvue9rkRUTFPlj4LmlbA8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0NTguNSw1ODIuNjg3NSw0NDguNSw1ODYuNjg3NSw0NTguNSw1OTAuNjg3NSw0NTQuNSw1ODYuNjg3NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDUyLjUiIHgyPSI2NjYuNSIgeTE9IjU4Ni42ODc1IiB5Mj0iNTg2LjY4NzUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNSIgeD0iNDY0LjUiIHk9IjU4MS42MjE2Ij5vazwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3NC41LDYxMS44MjAzLDE2NC41LDYxNS44MjAzLDE3NC41LDYxOS44MjAzLDE3MC41LDYxNS44MjAzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxNjguNSIgeDI9IjQ0MS41IiB5MT0iNjE1LjgyMDMiIHkyPSI2MTUuODIwMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1IiB4PSIxODAuNSIgeT0iNjEwLjc1NDQiPm9rPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDguNSw2NDAuOTUzMSwzOC41LDY0NC45NTMxLDQ4LjUsNjQ4Ljk1MzEsNDQuNSw2NDQuOTUzMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjQyLjUiIHgyPSIxNjIuNSIgeTE9IjY0NC45NTMxIiB5Mj0iNjQ0Ljk1MzEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNSIgeD0iNTQuNSIgeT0iNjM5Ljg4NzIiPm9rPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDI1LjUsNjcwLjA4NTksNDM1LjUsNjc0LjA4NTksNDI1LjUsNjc4LjA4NTksNDI5LjUsNjc0LjA4NTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE2My41IiB4Mj0iNDMxLjUiIHkxPSI2NzQuMDg1OSIgeTI9IjY3NC4wODU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM2IiB4PSIxNzAuNSIgeT0iNjY5LjAyIj5wcm9kdWNlKGF1ZGlvL3ZpZGVvKTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY1MC41LDY5OS4yMTg4LDY2MC41LDcwMy4yMTg4LDY1MC41LDcwNy4yMTg4LDY1NC41LDcwMy4yMTg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0NDcuNSIgeDI9IjY1Ni41IiB5MT0iNzAzLjIxODgiIHkyPSI3MDMuMjE4OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNSIgeD0iNDU0LjUiIHk9IjY5OC4xNTI4Ij50cmFuc3BvcnQucHJvZHVjZTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ1OC41LDcyOC4zNTE2LDQ0OC41LDczMi4zNTE2LDQ1OC41LDczNi4zNTE2LDQ1NC41LDczMi4zNTE2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSI0NTIuNSIgeDI9IjY2Ni41IiB5MT0iNzMyLjM1MTYiIHkyPSI3MzIuMzUxNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMiIgeD0iNDY0LjUiIHk9IjcyNy4yODU2Ij5wcm9kdWNlciBSVFDlj4LmlbA8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzQuNSw3NTcuNDg0NCwxNjQuNSw3NjEuNDg0NCwxNzQuNSw3NjUuNDg0NCwxNzAuNSw3NjEuNDg0NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMTY4LjUiIHgyPSI0MzYuNSIgeTE9Ijc2MS40ODQ0IiB5Mj0iNzYxLjQ4NDQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MSIgeD0iMTgwLjUiIHk9Ijc1Ni40MTg1Ij5SVFDlj4LmlbA8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NTAuNSw3ODkuNjE3Miw2NjAuNSw3OTMuNjE3Miw2NTAuNSw3OTcuNjE3Miw2NTQuNSw3OTMuNjE3MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDQyLjUiIHgyPSI2NTYuNSIgeTE9Ijc5My42MTcyIiB5Mj0iNzkzLjYxNzIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjIiIHg9IjQ0OS41IiB5PSI3ODguNTUxMyI+dHJhbnNwb3J0LmNvbnN1bWU8L3RleHQ+PHBhdGggZD0iTTY3Nyw3NzQuNDg0NCBMNjc3LDc5OS40ODQ0IEw5MTUsNzk5LjQ4NDQgTDkxNSw3ODQuNDg0NCBMOTA1LDc3NC40ODQ0IEw2NzcsNzc0LjQ4NDQgIiBmaWxsPSIjRkZGRkZGIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNOTA1LDc3NC40ODQ0IEw5MDUsNzg0LjQ4NDQgTDkxNSw3ODQuNDg0NCBMOTA1LDc3NC40ODQ0ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjE3IiB4PSI2ODMiIHk9Ijc5MS41NTEzIj7lnKhUcmFuc3BvcnTkuIrlu7rnq4tjb25zdW1lcueahOaYoOWwhDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ1My41LDgyMS43NSw0NDMuNSw4MjUuNzUsNDUzLjUsODI5Ljc1LDQ0OS41LDgyNS43NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iNDQ3LjUiIHgyPSI2NjYuNSIgeTE9IjgyNS43NSIgeTI9IjgyNS43NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2MCIgeD0iNDU5LjUiIHk9IjgyMC42ODQxIj5wcm9kdWNlcuWSjGNvbnN1bWVy54q25oCBPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc0LjUsODUzLjg4MjgsMTY0LjUsODU3Ljg4MjgsMTc0LjUsODYxLjg4MjgsMTcwLjUsODU3Ljg4MjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE2OC41IiB4Mj0iNDQxLjUiIHkxPSI4NTcuODgyOCIgeTI9Ijg1Ny44ODI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjU1IiB4PSIxODAuNSIgeT0iODUyLjgxNjkiPumAmuefpeWFtuS7luaIkOWRmG5ld0NvbnN1bWVyKGF1ZGlvL3ZpZGVvKTwvdGV4dD48cGF0aCBkPSJNNDQ3LDgzOC43NSBMNDQ3LDg2My43NSBMNjc2LDg2My43NSBMNjc2LDg0OC43NSBMNjY2LDgzOC43NSBMNDQ3LDgzOC43NSAiIGZpbGw9IiNGRkZGRkYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik02NjYsODM4Ljc1IEw2NjYsODQ4Ljc1IEw2NzYsODQ4Ljc1IEw2NjYsODM4Ljc1ICIgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjA4IiB4PSI0NTMiIHk9Ijg1NS44MTY5Ij7mnInmlrDkuIrooYzvvIznu5nlhbbku5bmiJDlkZjliJvlu7rkuIvooYzovazlj5E8L3RleHQ+PCEtLU1ENT1bMTNhZjNmMzVmNDk5NmNlZGNlZWM4MGU1NTMwMWRhOWRdCkBzdGFydHVtbA0Kc2tpbnBhcmFtIE5vdGVCYWNrZ3JvdW5kQ29sb3Igd2hpdGUNCg0Kd2VicnRjIC0gLT4gY2xpZW50IDogZ2V0TWVkaWFEZXZpY2UgDQpjbGllbnQgLT4gZGVtbyA6IGdldFJvdXRlclJ0cENhcGFiaWxpdGllcw0KYWN0aXZhdGUgZGVtbw0KZGVtbyAtPiBjbGllbnQgOiDov5Tlm55tZWRpYXNvdXDmlK/mjIHnmoRSVFDog73lipsNCmRlYWN0aXZhdGUgZGVtbw0KY2xpZW50IC0gLT4gd2VicnRjIDogc2V0IFNEUA0KDQpjbGllbnQgLT4gZGVtbyA6IGNyZWF0ZVdlYlJ0Y1RyYW5zcG9ydCh1cC9kb3duKQ0KYWN0aXZhdGUgZGVtbw0KZGVtbyAtPiBtZWRpYXNvdXAgOiByb3V0ZXIuY3JlYXRlV2ViUnRjVHJhbnNwb3J0DQphY3RpdmF0ZSBtZWRpYXNvdXANCm5vdGUgcmlnaHQgOiDliJvlu7rkuIrkuIvooYzkuKTkuKpUcmFuc3BvcnQNCm1lZGlhc291cCAtPiBkZW1vIDogSUNFL0RUTFMvU0NUUOWPguaVsA0KZGVhY3RpdmF0ZSBtZWRpYXNvdXANCmRlbW8gLT4gY2xpZW50IDogSUNFL0RUTFMvU0NUUOWPguaVsA0KZGVhY3RpdmF0ZSBkZW1vDQpjbGllbnQgLSAtPiB3ZWJydGMgOiBzZXQgU0RQDQoNCmNsaWVudCAtPiBkZW1vIDogam9pbg0KYWN0aXZhdGUgZGVtbw0KZGVtbyAtPiBjbGllbnQgOiBvdGhlciBwZWVycw0KZGVtbyAtPiBtZWRpYXNvdXAgOiB0cmFuc3BvcnQuY29uc3VtZQ0KZGVhY3RpdmF0ZSBkZW1vDQphY3RpdmF0ZSBtZWRpYXNvdXANCm5vdGUgcmlnaHQgOiDlnKhUcmFuc3BvcnTkuIrlu7rnq4tjb25zdW1lcueahOaYoOWwhA0KbWVkaWFzb3VwIC0+IGRlbW8gOiBwcm9kdWNlcuWSjGNvbnN1bWVy54q25oCBDQpkZWFjdGl2YXRlIG1lZGlhc291cA0KZGVtbyAtPiBjbGllbnQgOiDlj5Hnu5noh6rlt7FuZXdDb25zdW1lcihhdWRpby92aWRlbykNCm5vdGUgcmlnaHQgOiDmiormlrDov5vmiL/miJDlkZjlvZPlgZrlhbbku5blt7Lnu4/ov5vmiL/miJDlkZjnmoTkuIvooYwNCg0Kd2VicnRjIC0gLT4gY2xpZW50IDogRFRMU+WPguaVsA0KY2xpZW50IC0+IGRlbW8gOiBjb25uZWN0V2ViUnRjVHJhbnNwb3J0KHVwL2Rvd24pDQphY3RpdmF0ZSBkZW1vDQpkZW1vIC0+IG1lZGlhc291cCA6IHRyYW5zcG9ydC5jb25uZWN0DQphY3RpdmF0ZSBtZWRpYXNvdXANCm5vdGUgcmlnaHQgOiDorr7nva5EVExT5Y+C5pWwDQptZWRpYXNvdXAgLT4gZGVtbyA6IG9rDQpkZWFjdGl2YXRlIG1lZGlhc291cA0KZGVtbyAtPiBjbGllbnQgOiBvaw0KZGVhY3RpdmF0ZSBkZW1vDQpjbGllbnQgLSAtPiB3ZWJydGMgOiBvaw0KDQpjbGllbnQgLT4gZGVtbyA6IHByb2R1Y2UoYXVkaW8vdmlkZW8pDQphY3RpdmF0ZSBkZW1vDQpkZW1vIC0+IG1lZGlhc291cCA6IHRyYW5zcG9ydC5wcm9kdWNlDQphY3RpdmF0ZSBtZWRpYXNvdXANCm1lZGlhc291cCAtPiBkZW1vIDogcHJvZHVjZXIgUlRQ5Y+C5pWwDQpkZWFjdGl2YXRlIG1lZGlhc291cA0KZGVtbyAtPiBjbGllbnQgOiBSVFDlj4LmlbANCmRlbW8gLT4gbWVkaWFzb3VwIDogdHJhbnNwb3J0LmNvbnN1bWUNCmRlYWN0aXZhdGUgZGVtbw0KYWN0aXZhdGUgbWVkaWFzb3VwDQpub3RlIHJpZ2h0IDog5ZyoVHJhbnNwb3J05LiK5bu656uLY29uc3VtZXLnmoTmmKDlsIQNCm1lZGlhc291cCAtPiBkZW1vIDogcHJvZHVjZXLlkoxjb25zdW1lcueKtuaAgQ0KZGVhY3RpdmF0ZSBtZWRpYXNvdXANCmRlbW8gLT4gY2xpZW50IDog6YCa55+l5YW25LuW5oiQ5ZGYbmV3Q29uc3VtZXIoYXVkaW8vdmlkZW8pDQpub3RlIHJpZ2h0IDog5pyJ5paw5LiK6KGM77yM57uZ5YW25LuW5oiQ5ZGY5Yib5bu65LiL6KGM6L2s5Y+RDQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjIuM2JldGEyKFVua25vd24gY29tcGlsZSB0aW1lKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogSmF2YShUTSkgU0UgUnVudGltZSBFbnZpcm9ubWVudApKVk06IEphdmEgSG90U3BvdChUTSkgNjQtQml0IFNlcnZlciBWTQpEZWZhdWx0IEVuY29kaW5nOiBVVEYtOApMYW5ndWFnZTogZW4KQ291bnRyeTogVVMKLS0+PC9nPjwvc3ZnPg=='>
<h2 id="动手实现一个Mediasoup-client"><a href="#动手实现一个Mediasoup-client" class="headerlink" title="动手实现一个Mediasoup client"></a>动手实现一个Mediasoup client</h2><p>使用pion提供的webrtc库实现一个可以对接mediasoup的client小工具，使用的语言主要为golang。</p>
<h3 id="建立媒体传输通道"><a href="#建立媒体传输通道" class="headerlink" title="建立媒体传输通道"></a>建立媒体传输通道</h3><p>因为mediasoup把SDP拆成了几条信令在websocket上协商，因此需要把SDP中的字段拆解成所需要的字段封装在client端和给mediasoup server。</p>
<h4 id="ICE"><a href="#ICE" class="headerlink" title="ICE"></a>ICE</h4><p>从webrtc transport信令中拿到candidate列表，因为mediasoup是lite的ICE，client端是controlling，mediasoup是controlled，只需要从client去建立连接即可。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 创建ice agent</span></span><br><span class="line">iceAgent, err := ice.NewAgent(&amp;ice.AgentConfig&#123;</span><br><span class="line">    NetworkTypes: []ice.NetworkType&#123;ice.NetworkTypeUDP4&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把candidate加入ice的列表里</span></span><br><span class="line">iceAgent.AddRemoteCandidate(candidate)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line">iceConn, err := iceAgent.Dial(context.Background(), rsp.Answer.IceParameters.UsernameFragment, rsp.Answer.IceParameters.Password)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此，和webrtctransport的ice连接就建立了一半，接下来在ice的基础上做dtls密钥交换。</p>
<h4 id="DTLS"><a href="#DTLS" class="headerlink" title="DTLS"></a>DTLS</h4><p>mediasoup支持双向的dtls连接，dtls之后将密钥导出到ice的connection，对rtp的payload进行加密，媒体数据走的是srtp标准协议。</p>
<p>生成dtls证书和指纹</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment">// 不使用pem证书文件，自签名生成证书，对证书计算摘要</span></span><br><span class="line"><span class="keyword">var</span> tlsCerts []tls.Certificate</span><br><span class="line">certificate, err := selfsign.GenerateSelfSigned()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> mediasoupFPs, tlsCerts, err</span><br><span class="line">&#125;</span><br><span class="line">x509cert, err := x509.ParseCertificate(certificate.Certificate[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> mediasoupFPs, tlsCerts, err</span><br><span class="line">&#125;</span><br><span class="line">actualSHA256, err := fingerprint.Fingerprint(x509cert, crypto.SHA256)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> mediasoupFPs, tlsCerts, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将dtls指纹参数通过信令发送给mediasoup，然后进行dtls连接即可，dtls可使用server也可以使用client，通过信令参数均可调整。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">config := &amp;dtls.Config&#123;</span><br><span class="line">	Certificates:         tlsCerts,</span><br><span class="line">	ExtendedMasterSecret: dtls.RequireExtendedMasterSecret,</span><br><span class="line">	<span class="comment">// Create timeout context for accepted connection.</span></span><br><span class="line">	ConnectContextMaker: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(context.Context, <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> context.WithTimeout(context.Background(), <span class="number">30</span>*time.Second)</span><br><span class="line">	&#125;,</span><br><span class="line">	SRTPProtectionProfiles: []dtls.SRTPProtectionProfile&#123;dtls.SRTP_AES128_CM_HMAC_SHA1_80&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   dtlsConn, err := dtls.Server(iceConn, config) <span class="comment">// or Client</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此，媒体通道webrtc transport已经建立。</p>
<h3 id="媒体传输"><a href="#媒体传输" class="headerlink" title="媒体传输"></a>媒体传输</h3><p>srtp不需要对整个数据包进行加密，因此收发数据仍然是在ice的connection上进行，但是将dtls的密钥导出用于加密每一个rtp的payload。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment">// 导出dtls密钥</span></span><br><span class="line">srtpConfig := &amp;srtp.Config&#123;</span><br><span class="line">	Profile: srtp.ProtectionProfileAes128CmHmacSha1_80,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">connState := dtlsConn.ConnectionState()</span><br><span class="line"><span class="keyword">if</span> err := srtpConfig.ExtractSessionKeysFromDTLS(&amp;connState, <span class="literal">false</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;errDtlsKeyExtractionFailed: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 建立srtp session</span></span><br><span class="line">   srtpSession, err := srtp.NewSessionSRTP(iceConn, srtpConfig)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 建立srtp读写handler</span></span><br><span class="line">   rtpWriteStream, err := srtpSession.OpenWriteStream()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 建立srtcp session</span></span><br><span class="line">   srtcpSession, err := srtp.NewSessionSRTCP(iceConn, srtpConfig)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 建立srtcp读写handler</span></span><br><span class="line">   rtcpReadStream, err := srtcpSession.OpenReadStream(opt.SSRC)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将RTP包的header和payload分别填入handler即可在之前建立的媒体通道上进行收发媒体。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/versatica/mediasoup">源码实现</a></p>
<p><a target="_blank" rel="noopener" href="https://mediasoup.org/">官网</a></p>
<p><a target="_blank" rel="noopener" href="https://mediasoup.discourse.group/">官方讨论组</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/jiyeyuran/mediasoup-go">golang实现信令层</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2020/10/03/2020-10-04-rtc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/03/2020-10-04-rtc/" class="post-title-link" itemprop="url">RTC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-10-04T00:00:00+08:00">2020-10-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/" itemprop="url" rel="index"><span itemprop="name">media</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RTC"><a href="#RTC" class="headerlink" title="RTC"></a>RTC</h1><h2 id="RTC-Server"><a href="#RTC-Server" class="headerlink" title="RTC Server"></a>RTC Server</h2><h3 id="流媒体服务器"><a href="#流媒体服务器" class="headerlink" title="流媒体服务器"></a>流媒体服务器</h3><p>媒体数据的传输，实现实时传输的最基本功能。</p>
<h3 id="信令服务器"><a href="#信令服务器" class="headerlink" title="信令服务器"></a>信令服务器</h3><p>管理多路用户的逻辑，将多个通信用户组建房间进行权限控制和资源管理。</p>
<h3 id="打洞服务器"><a href="#打洞服务器" class="headerlink" title="打洞服务器"></a>打洞服务器</h3><p>为媒体传输提供更丰富的传输通道。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><strong>CDN</strong></p>
<p>提供就近接入和媒体缓存。</p>
<p><strong>专线</strong></p>
<p>复杂网络情况中提升各运营商之间传输质量。</p>
<p><img src="/images/pic/RTC.png" alt="RTC"></p>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p>NAT解决了IPv4资源不足问题，将端口和IP隐藏在内网，从而提高安全性</p>
<ol>
<li>完全锥型</li>
<li>IP限制型</li>
<li>端口限制型</li>
<li>对称型</li>
</ol>
<p><img src="/images/pic/STUN.png" alt="STUN"></p>
<p>组网的网关就像一道墙，阻隔着外部host和内网host直接访问。身处两个NAT后面的host不得不借助于打洞服务器来探测和协助两个host相互访问。因此，以上4种类型的组合情况有12种。</p>
<p><strong>完全锥形</strong>比较容易理解，就是一个四元组：</p>
<pre><code> &#123;
   内网IP，
   内网端口，
   映射的外网IP，
   映射的外网端口
 &#125;
 
</code></pre>
<p>这个映射四元组就是墙上的“洞”，NAT通过查找这个映射表来转发数据。完全锥形没有任何限制，内网的任何host都可以通过这个“洞”和外界通信。</p>
<p><strong>IP限制型</strong>，多加了一个元组：</p>
<blockquote>
<p>被访问主机的IP</p>
</blockquote>
<p>即限制了内网其他IP的host不能通过这个洞。</p>
<p><strong>端口限制型</strong>，又多加了一个元组：</p>
<blockquote>
<p>被访问主机的端口</p>
</blockquote>
<p>即限制了内网同个host的其他端口不能通过这个洞。</p>
<p>最复杂和多变的对称型，对于同一个外网host访问内网host1和host2，它映射的IP和端口都是变化的，因此：<code>对称型—对称型</code>和<code>对称型—端口限制型</code>这两种情况在STUN中是无法穿越的。</p>
<p>NAT穿越为媒体传输通道提供了直连的选择，同一局域网应该首选直连通道。其他情况可根据业务需求和质量情况来判断选择哪种通道。</p>
<h2 id="多对多通信"><a href="#多对多通信" class="headerlink" title="多对多通信"></a>多对多通信</h2><h3 id="Mesh方案"><a href="#Mesh方案" class="headerlink" title="Mesh方案"></a>Mesh方案</h3><p>思想基于一对一方案，将每个host之间都建立一个连接，且每个host之间都能打通直连通道。</p>
<p>局限性：</p>
<ol>
<li>现实场景中，不一定每个host之间都能建立直连通道</li>
<li>共享媒体流的时候，将给每个对端发送一份数据，上行带宽很大</li>
</ol>
<h3 id="MCU方案"><a href="#MCU方案" class="headerlink" title="MCU方案"></a>MCU方案</h3><p><strong>Multipoint Conferencing Unit</strong></p>
<p>服务器进行多路混流和重新编码，视频会议场景等，对服务器硬件要求高。<br>优势很明显，场景体验好，节省带宽资源。<br>局限性也很明显，对服务器要求高，混流过程有一定的延时。</p>
<h3 id="SFU方案"><a href="#SFU方案" class="headerlink" title="SFU方案"></a>SFU方案</h3><p><strong>Selective Forwarding Unit</strong></p>
<p>服务器对多路流根据实际场景进行转发。</p>
<h3 id="传输质量"><a href="#传输质量" class="headerlink" title="传输质量"></a>传输质量</h3><p><img src="/images/pic/QoS.png" alt="QoS"></p>
<h3 id="流媒体传输协议"><a href="#流媒体传输协议" class="headerlink" title="流媒体传输协议"></a>流媒体传输协议</h3><p>传统直播推拉流架构的主要协议：HLS和RTMP协议。</p>
<p>由于WebRTC传输数据基于UDP协议，RTMP基于TCP协议，HLS基于HTTP协议的特点，传输实时性：<code>WebRTC(RTCP/RTP) &gt; RTMP &gt; HLS</code></p>
<ul>
<li>WebRTC多用于实时音视频通信或互动场景</li>
<li>RTMP多用于推拉流场景</li>
<li>HLS多用于拉流端和点播场景</li>
</ul>
<p><img src="/images/pic/HLS.png" alt="HLS"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2020/05/26/2020-05-27-golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/26/2020-05-27-golang/" class="post-title-link" itemprop="url">Golang</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-27 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-27T00:00:00+08:00">2020-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/images/svg/Golang.svg">outline</a><br><img src="/images/svg/Golang.svg"></p>
<p>支持判等类型: 布尔，数字，字符串，指针，接口，通道，结构体，包含上述类型的数组<br>不支持判等类型: slice, map, function</p>
<p><a href="/images/svg/context.svg">context</a><br><img src="/images/svg/context.svg"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2020/05/26/2020-05-27-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/26/2020-05-27-mysql/" class="post-title-link" itemprop="url">MySQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-27 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-27T00:00:00+08:00">2020-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/images/svg/MySQL.svg">outline</a><br><img src="/images/svg/MySQL.svg"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2020/05/25/2020-05-26-quic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/25/2020-05-26-quic/" class="post-title-link" itemprop="url">QUIC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-26 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-26T00:00:00+08:00">2020-05-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/protocol/" itemprop="url" rel="index"><span itemprop="name">protocol</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="延迟是性能瓶颈"><a href="#延迟是性能瓶颈" class="headerlink" title="延迟是性能瓶颈"></a>延迟是性能瓶颈</h3><p>HTTP/0.9到HTTP/1.x的主要提升是丰富了方法类型。</p>
<p>打开一个网页经过:</p>
<ol>
<li>DNS 查询</li>
<li>建立连接</li>
<li>请求</li>
<li>响应</li>
</ol>
<p>HTTP/1.x的每一次请求之间是串行的，即前一个request得到响应后才能发起下一个request，耗时为所有请求和响应耗时的总和。<br>HTTP/2.x开始支持多路复用，允许在同个连接上同时发起多个request，在多个请求的情况下，耗时大大减少。</p>
<p>HTTP/2借鉴了很多SPDY的提案，比如优先级和多路复用。</p>
<h3 id="二进制分帧层"><a href="#二进制分帧层" class="headerlink" title="二进制分帧层"></a>二进制分帧层</h3><p>HTTP/2 所有性能增强的核心在于新的二进制分帧层，它定义了如何封装 HTTP 消息并在客户端与服务器之间传输。HTTP/2 将 HTTP 协议通信分解为二进制编码帧的交换，这些帧对应着特定数据流中的消息。所有这些都在一个 TCP 连接内复用。 这是 HTTP/2 协议所有其他功能和性能优化的基础。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn">https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2020/03/06/2020-03-07-websocket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/06/2020-03-07-websocket/" class="post-title-link" itemprop="url">WebSocket</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-07 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-07T00:00:00+08:00">2020-03-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/protocol/" itemprop="url" rel="index"><span itemprop="name">protocol</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="全双工协议"><a href="#全双工协议" class="headerlink" title="全双工协议"></a>全双工协议</h3><p>简而言之，许多应用场景需要全双工的web应用，例如：服务器主动推送和实时交互的应用。这些应用不适合在HTTP协议上实现。最好的方式是使用HTTP建立握手，之后基于TCP做长连接。</p>
<p>与HTTP的关系是：使用了其握手机制和端口号。</p>
<blockquote>
<p>Relationship to TCP and HTTP</p>
</blockquote>
<blockquote>
<p>   The WebSocket Protocol is an independent TCP-based protocol.  Its<br>   only relationship to HTTP is that its handshake is interpreted by<br>   HTTP servers as an Upgrade request.</p>
</blockquote>
<blockquote>
<p>   By default, the WebSocket Protocol uses port 80 for regular WebSocket<br>   connections and port 443 for WebSocket connections tunneled over<br>   Transport Layer Security (TLS) [RFC2818].</p>
</blockquote>
<p>   <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Comparison_of_WebSocket_implementations">支持WebSocket的浏览器</a></p>
<h3 id="握手"><a href="#握手" class="headerlink" title="握手"></a>握手</h3><p>WebSocket通过HTTP/1.1协议的101状态码握手。</p>
<p><strong>客户端发起握手请求：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">ws://localhost:6060/ws</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:6060</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade   # 连接升级</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket    # 升级到WebSocket</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://localhost:6060</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13   # 表示支持的WebSocket版本</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,ja;q=0.6,zh-TW;q=0.5</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>wp-settings-time-1=1566626634</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>Omt7iN7CaEUxYdm+wlVEaA==</span><br><span class="line"><span class="attribute">Sec-WebSocket-Extensions</span><span class="punctuation">: </span>permessage-deflate; client_max_window_bits</span><br></pre></td></tr></table></figure>

<p><strong>服务器回应</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>ggdcU6xoySObbFCh62I2J3eRxu0=</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Sec-WebSocket-Key</code>是随机的字符串，服务器端会用这些数据来构造出一个SHA-1的信息摘要。把<code>Sec-WebSocket-Key</code>加上一个特殊字符串（固定）：<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>，然后计算SHA-1摘要，之后进行BASE-64编码，将结果做为<code>Sec-WebSocket-Accept</code>头的值，返回给客户端。如此操作，可以尽量避免普通HTTP请求被误认为Websocket协议。</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 固定字符串</span></span><br><span class="line"><span class="keyword">var</span> keyGUID = []<span class="keyword">byte</span>(<span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务器根据客户端请求的随机key计算Sec-WebSocket-Accept字段的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeAcceptKey</span><span class="params">(challengeKey <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	h := sha1.New()</span><br><span class="line">	h.Write([]<span class="keyword">byte</span>(challengeKey))</span><br><span class="line">	h.Write(keyGUID)</span><br><span class="line">	<span class="keyword">return</span> base64.StdEncoding.EncodeToString(h.Sum(<span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端生成随机key</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateChallengeKey</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	p := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">16</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := io.ReadFull(rand.Reader, p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> base64.StdEncoding.EncodeToString(p), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Origin</code>字段是可选的，通常用来表示在浏览器中发起此Websocket连接所在的页面。</li>
</ul>
<h3 id="协议格式"><a href="#协议格式" class="headerlink" title="协议格式"></a>协议格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16&#x2F;64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len&#x3D;&#x3D;126&#x2F;127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len &#x3D;&#x3D; 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><code>FIN</code>为true表示是最后一个分片。</li>
<li><code>RSV</code>一般情况都为0。</li>
<li><code>opcode</code> 定义了<code>payload data</code>的类型。</li>
<li><code>mask</code>为true表示payload是编码处理的。</li>
<li><code>masking-key</code>编码key。</li>
<li><code>payload length</code>表示payload的长度。</li>
</ul>
<p>extend为payload过长时的扩展字段。</p>
<p>客户端发给服务器的包，必须masking：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> wordSize = <span class="keyword">int</span>(unsafe.Sizeof(<span class="keyword">uintptr</span>(<span class="number">0</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 随机生成masking-key</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMaskKey</span><span class="params">()</span> [4]<span class="title">byte</span></span> &#123;</span><br><span class="line">	n := rand.Uint32()</span><br><span class="line">	<span class="keyword">return</span> [<span class="number">4</span>]<span class="keyword">byte</span>&#123;<span class="keyword">byte</span>(n), <span class="keyword">byte</span>(n &gt;&gt; <span class="number">8</span>), <span class="keyword">byte</span>(n &gt;&gt; <span class="number">16</span>), <span class="keyword">byte</span>(n &gt;&gt; <span class="number">24</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">maskBytes</span><span class="params">(key [4]<span class="keyword">byte</span>, pos <span class="keyword">int</span>, b []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="comment">// Mask one byte at a time for small buffers.</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b) &lt; <span class="number">2</span>*wordSize &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">			b[i] ^= key[pos&amp;<span class="number">3</span>]</span><br><span class="line">			pos++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> pos &amp; <span class="number">3</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Mask one byte at a time to word boundary.</span></span><br><span class="line">	<span class="keyword">if</span> n := <span class="keyword">int</span>(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;b[<span class="number">0</span>]))) % wordSize; n != <span class="number">0</span> &#123;</span><br><span class="line">		n = wordSize - n</span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> b[:n] &#123;</span><br><span class="line">			b[i] ^= key[pos&amp;<span class="number">3</span>]</span><br><span class="line">			pos++</span><br><span class="line">		&#125;</span><br><span class="line">		b = b[n:]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create aligned word size key.</span></span><br><span class="line">	<span class="keyword">var</span> k [wordSize]<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> k &#123;</span><br><span class="line">		k[i] = key[(pos+i)&amp;<span class="number">3</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	kw := *(*<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;k))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Mask one word at a time.</span></span><br><span class="line">	n := (<span class="built_in">len</span>(b) / wordSize) * wordSize</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i += wordSize &#123;</span><br><span class="line">		*(*<span class="keyword">uintptr</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;b[<span class="number">0</span>])) + <span class="keyword">uintptr</span>(i))) ^= kw</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Mask one byte at a time for remaining bytes.</span></span><br><span class="line">	b = b[n:]</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">		b[i] ^= key[pos&amp;<span class="number">3</span>]</span><br><span class="line">		pos++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pos &amp; <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="控制消息"><a href="#控制消息" class="headerlink" title="控制消息"></a>控制消息</h3><p>WebSocket定义了3种类型的控制消息（control message）：close, ping and pong。</p>
<p><strong>close</strong></p>
<p><code>opcode</code>为0x8</p>
<p>客户端发起的close，<code>websocket.payload.close.status_code</code>置为1000，表示normal closure。若不设置，则默认为CloseNoStatusReceived=1005。</p>
<p>服务器收到关闭请求，响应包也发送1000。</p>
<p>客户端收到响应后，执行TCP四次挥手过长，双方关闭TCP连接。</p>
<p>在实际捕获websocket的close code时，应注意以下细节：</p>
<ul>
<li><code>1006</code>属于错误码，并不是可从<code>SetCloseHandler</code>中捕获到的，因为它没有真正的发送close消息。</li>
<li>若websocket由Nginx代理，应考虑Nginx可能会主动发送close的情况，因此应该从读取message的地方去获取断开原因，因为<code>SetCloseHandler</code>有可能会接收到Nginx发来的close状态。</li>
</ul>
<p><strong>ping</strong></p>
<p><code>opcode</code>为0x9</p>
<p>发送方 -&gt; 接收方</p>
<blockquote>
<p> WebSocket为了保持客户端、服务端的实时双向通信，需要确保客户端、服务端之间的TCP通道保持连接没有断开。然而，对于长时间没有数据往来的连接，如果依旧长时间保持着，可能会浪费包括的连接资源。但不排除有些场景，客户端、服务端虽然长时间没有数据往来，但仍需要保持连接。这个时候，可以采用心跳来实现。</p>
</blockquote>
<blockquote>
<p>如果客户端支持ping，最好由客户端发起ping，然后服务器记录时间，超时断开即可。浏览器中没有相关api发送ping给服务器，只能由服务器发ping给浏览器。</p>
</blockquote>
<p><strong>pong</strong></p>
<p><code>opcode</code>为0xA</p>
<p>接收方 -&gt; 发送方</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6455">https://tools.ietf.org/html/rfc6455</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/WebSocket">https://zh.wikipedia.org/wiki/WebSocket</a></p>
<p><a target="_blank" rel="noopener" href="https://godoc.org/github.com/gorilla/websocket">https://godoc.org/github.com/gorilla/websocket</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/gorilla/websocket">https://github.com/gorilla/websocket</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/gorilla/websocket/blob/master/examples/chat/client.go">websocket ping/pong timeout</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2019/08/19/2019-08-14-use-brook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/19/2019-08-14-use-brook/" class="post-title-link" itemprop="url">Use of Brook</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-20T00:00:00+08:00">2019-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/how2use/" itemprop="url" rel="index"><span itemprop="name">how2use</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><em><strong>声明：仅用于交流学习技术</strong></em></p>
<h3 id="购买服务器（此部分略）"><a href="#购买服务器（此部分略）" class="headerlink" title="购买服务器（此部分略）"></a>购买服务器（此部分略）</h3><h3 id="BBR"><a href="#BBR" class="headerlink" title="BBR"></a>BBR</h3><p>若服务器支持BBR，可使用以下命令一键安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget</span><br><span class="line">wget –no-check-certificate https:&#x2F;&#x2F;github.com&#x2F;teddysun&#x2F;across&#x2F;raw&#x2F;master&#x2F;bbr.sh</span><br><span class="line">chmod +x bbr.sh</span><br><span class="line">.&#x2F;bbr.sh</span><br></pre></td></tr></table></figure>

<h3 id="server端debug模式"><a href="#server端debug模式" class="headerlink" title="server端debug模式"></a>server端debug模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;brook -d servers -l &quot;:port password&quot;</span><br></pre></td></tr></table></figure>
<p>查看防火墙状态命令：<code>firewall-cmd --state</code></p>
<p>停止firewall命令：<code>systemctl stop firewalld.service</code></p>
<p>禁止firewall开机启动命令：<code>systemctl disable firewalld.service</code></p>
<h3 id="客户端debug连接测试"><a href="#客户端debug连接测试" class="headerlink" title="客户端debug连接测试"></a>客户端debug连接测试</h3><p>建立隧道</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;brook_darwin_amd64 -d tunnel -l 127.0.0.1:1080 -t 8.8.8.8:53 -s server-ip:server-port -p password</span><br></pre></td></tr></table></figure>
<p>dig测试UDP和TCP是否连通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># UDP</span><br><span class="line">dig google.com @127.0.0.1 -p 1080</span><br><span class="line"></span><br><span class="line"># TCP</span><br><span class="line">dig +tcp google.com @127.0.0.1 -p 1080</span><br></pre></td></tr></table></figure>

<h3 id="使用GUI-client"><a href="#使用GUI-client" class="headerlink" title="使用GUI client"></a>使用GUI client</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install brook</span><br></pre></td></tr></table></figure>

<p>每次启动进程时，都会在自动代理里添加：<code>https://blackwhite.txthinking.com/white.pac</code></p>
<p>即添加访问规则</p>
<h3 id="terminal使用代理"><a href="#terminal使用代理" class="headerlink" title="terminal使用代理"></a>terminal使用代理</h3><p>在~/.bash_profile后添加配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy&#x3D;socks5:&#x2F;&#x2F;127.0.0.1:1080</span><br><span class="line">export https_proxy&#x3D;socks5:&#x2F;&#x2F;127.0.0.1:1080</span><br></pre></td></tr></table></figure>

<p>source使之立即生效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://byyam.github.io/2017/12/24/2017-12-24-job-scheduling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yam">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yam's Notebook">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/24/2017-12-24-job-scheduling/" class="post-title-link" itemprop="url">Job scheduling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-12-24 23:00:00" itemprop="dateCreated datePublished" datetime="2017-12-24T23:00:00+08:00">2017-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-11 16:47:21" itemprop="dateModified" datetime="2022-03-11T16:47:21+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/algorithms/" itemprop="url" rel="index"><span itemprop="name">algorithms</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Job scheduling</strong></p>
<p><strong>作业调度</strong></p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>多个作业进程（或服务器，后称为process）可处理相同的任务，并具有不同的处理能力。</p>
<h3 id="假设"><a href="#假设" class="headerlink" title="假设"></a>假设</h3><table>
<thead>
<tr>
<th>进程（服务器）</th>
<th>处理能力</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>4</td>
</tr>
<tr>
<td>B</td>
<td>3</td>
</tr>
<tr>
<td>C</td>
<td>2</td>
</tr>
</tbody></table>
<p>在一轮任务（Job）的分配中，均衡的分配给每一个process。</p>
<p>处理能力可认为是分配权重weight。</p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><h3 id="加权轮询调度"><a href="#加权轮询调度" class="headerlink" title="加权轮询调度"></a>加权轮询调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Supposing that there is a server set S &#x3D; &#123;S0, S1, …, Sn-1&#125;;</span><br><span class="line">W(Si) indicates the weight of Si;</span><br><span class="line">i indicates the server selected last time, and i is initialized with -1;</span><br><span class="line">cw is the current weight in scheduling, and cw is initialized with zero; </span><br><span class="line">max(S) is the maximum weight of all the servers in S;</span><br><span class="line">gcd(S) is the greatest common divisor of all server weights in S;</span><br><span class="line"></span><br><span class="line">while (true) &#123;</span><br><span class="line">    i &#x3D; (i + 1) mod n;</span><br><span class="line">    if (i &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        cw &#x3D; cw - gcd(S); </span><br><span class="line">        if (cw &lt;&#x3D; 0) &#123;</span><br><span class="line">            cw &#x3D; max(S);</span><br><span class="line">            if (cw &#x3D;&#x3D; 0)</span><br><span class="line">            return NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    if (W(Si) &gt;&#x3D; cw) </span><br><span class="line">        return Si;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出的结果是<code>AABABCABC</code></p>
<p>这个算法的两个技巧：</p>
<ol>
<li>gcd最大公约数：相当于算法的步长。比如权重为1000，100，10的三个process，分配时可以认为它们是权重为100，10，1.最大公约数为10，循环执行10次的效果是一样的。</li>
<li>当W(Si) &gt;= cw时，才返回Si。这样做的效果是，不同process中优先调用高于其他weight的部分，当所有process剩下的weight相等时，按顺序循环调用。</li>
</ol>
<h3 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h3><p><a target="_blank" rel="noopener" href="https://gist.github.com/byyam/6fe49cc9861b9134025c8234517f778a">python实现</a></p>
<h3 id="更为随机的加权轮询调度"><a href="#更为随机的加权轮询调度" class="headerlink" title="更为随机的加权轮询调度"></a>更为随机的加权轮询调度</h3><p>设想<code>A，B，C</code>的权值分别为<code>5，1，1</code>的情景下，以上的调度算法输出为<code>AAAAABC</code></p>
<p>定义：</p>
<ol>
<li>每个process的动态当前权值current weight为cw</li>
<li>每个process的固有权值weight为w</li>
<li>参加轮询的process的weight之和为sw</li>
</ol>
<p>算法：</p>
<ol>
<li>每个cw初始值为0</li>
<li>每个cw = cw + w</li>
<li>被选中的process为cw最大的，被选中后cw的值被惩罚为该process的cw减去sw，而其他process的cw保持不变。即max(cw) - sw</li>
<li>若所有process的cw都为0，则一轮结束。否则，进行下一步</li>
<li>跳到第2步</li>
</ol>
<p>运算：</p>
<p>奇数行根据最大的current weight选择process</p>
<p>被选中的cw被高亮标出</p>
<table>
<thead>
<tr>
<th>A</th>
<th>B</th>
<th>C</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><code>5</code></td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>-2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><code>3</code></td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>-4</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>1</td>
<td><code>3</code></td>
<td>3</td>
</tr>
<tr>
<td>1</td>
<td>-4</td>
<td>3</td>
</tr>
<tr>
<td><code>6</code></td>
<td>-3</td>
<td>4</td>
</tr>
<tr>
<td>-1</td>
<td>-3</td>
<td>4</td>
</tr>
<tr>
<td>4</td>
<td>-2</td>
<td><code>5</code></td>
</tr>
<tr>
<td>4</td>
<td>-2</td>
<td>-2</td>
</tr>
<tr>
<td><code>9</code></td>
<td>-1</td>
<td>-1</td>
</tr>
<tr>
<td>2</td>
<td>-1</td>
<td>-1</td>
</tr>
<tr>
<td><code>7</code></td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>技巧：</p>
<ol>
<li>算法里循环执行的<code>cw = cw + w</code>和<code>max（cw）-sw</code>两个步骤确保了cw之和等于sw，循环次数为<code>sw</code>次</li>
<li>和上一个算法相比，该算法每次让被选出来的process尽可能的排在最后面，确保了不会有连续的被选中</li>
</ol>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>加权轮询调度算法：</p>
<p><a target="_blank" rel="noopener" href="http://kb.linuxvirtualserver.org/wiki/Weighted_Round-Robin_Scheduling">http://kb.linuxvirtualserver.org/wiki/Weighted_Round-Robin_Scheduling</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yam</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/byyam" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;byyam" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yam</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
