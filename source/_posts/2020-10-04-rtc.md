---
layout: post
title:  "RTC"
date:   2020-10-04 00:00:00
categories: media

---

# RTC
## RTC Server

### 流媒体服务器

媒体数据的传输，实现实时传输的最基本功能。

### 信令服务器

管理多路用户的逻辑，将多个通信用户组建房间进行权限控制和资源管理。

### 打洞服务器

为媒体传输提供更丰富的传输通道。

### 其他

**CDN**

提供就近接入和媒体缓存。

**专线**

复杂网络情况中提升各运营商之间传输质量。


![RTC](/images/pic/RTC.png)

## NAT
NAT解决了IPv4资源不足问题，将端口和IP隐藏在内网，从而提高安全性

1. 完全锥型
2. IP限制型
3. 端口限制型
4. 对称型

![STUN](/images/pic/STUN.png)


组网的网关就像一道墙，阻隔着外部host和内网host直接访问。身处两个NAT后面的host不得不借助于打洞服务器来探测和协助两个host相互访问。因此，以上4种类型的组合情况有12种。

**完全锥形**比较容易理解，就是一个四元组：

	 {
	   内网IP，
	   内网端口，
	   映射的外网IP，
	   映射的外网端口
	 }
	 
这个映射四元组就是墙上的“洞”，NAT通过查找这个映射表来转发数据。完全锥形没有任何限制，内网的任何host都可以通过这个“洞”和外界通信。

**IP限制型**，多加了一个元组：
> 被访问主机的IP

即限制了内网其他IP的host不能通过这个洞。

**端口限制型**，又多加了一个元组：
> 被访问主机的端口

即限制了内网同个host的其他端口不能通过这个洞。

最复杂和多变的对称型，对于同一个外网host访问内网host1和host2，它映射的IP和端口都是变化的，因此：`对称型—对称型`和`对称型—端口限制型`这两种情况在STUN中是无法穿越的。

NAT穿越为媒体传输通道提供了直连的选择，同一局域网应该首选直连通道。其他情况可根据业务需求和质量情况来判断选择哪种通道。

## 多对多通信

### Mesh方案
思想基于一对一方案，将每个host之间都建立一个连接，且每个host之间都能打通直连通道。

局限性：
1. 现实场景中，不一定每个host之间都能建立直连通道
2. 共享媒体流的时候，将给每个对端发送一份数据，上行带宽很大

### MCU方案
**Multipoint Conferencing Unit**

服务器进行多路混流和重新编码，视频会议场景等，对服务器硬件要求高。
优势很明显，场景体验好，节省带宽资源。
局限性也很明显，对服务器要求高，混流过程有一定的延时。

### SFU方案
**Selective Forwarding Unit**

服务器对多路流根据实际场景进行转发。


### 传输质量


![QoS](/images/pic/QoS.png)


### 流媒体传输协议

传统直播推拉流架构的主要协议：HLS和RTMP协议。

由于WebRTC传输数据基于UDP协议，RTMP基于TCP协议，HLS基于HTTP协议的特点，传输实时性：`WebRTC(RTCP/RTP) > RTMP > HLS`

* WebRTC多用于实时音视频通信或互动场景
* RTMP多用于推拉流场景
* HLS多用于拉流端和点播场景


![HLS](/images/pic/HLS.png)

## 算法设计

在实时传输中，一般使用UDP协议，因此需要对抗丢包，乱序，抖动等质量问题。在实时和可靠之间做权衡，一切都是trade-off。
### NACK

目标： 既要做到及时快速的重传，又要避免过多过久的重传，减少带宽的使用。

思路1： 收到包时记录seq，定时检查最近1000个包里丢失了哪些，发送RTCP NACK请求。
问题：定时器间隔导致丢包不能快速请求。

思路2： 思路1+每次收到包都触发一次快速请求重传。
问题：乱序时误重传，浪费带宽。

思路3： 思路2+为避免即时和定时频繁发送NACK请求的问题，根据rtt推算是否在定时器触发时需要再次请求NACK，并记录包的重传次数，超过一定次数则停止再发重传请求。

弱网环境下的补充：若重传队列过长，可清理至上一个keyframe处的seq。若队列还是过长，可直接清空重传队列，并发送RTCP PLI请求。

